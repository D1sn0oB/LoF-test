<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜…è¯»å™¨ - God Reader</title>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* å…¨å±€éšè—æ»šåŠ¨æ¡ */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        /* å…¨å±€éšè—æ»šåŠ¨æ¡ */
        *::-webkit-scrollbar {
            display: none;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #f8f9ff;
            color: #333;
            overflow: hidden;
            height: 100vh;
        }
        
        .reader-container {
            display: flex;
            height: 100vh;
            position: relative;
        }
        
        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 300px;
            background-color: white;
            border-right: 1px solid #f0f0f0;
            transition: transform 0.3s ease;
            transform: translateX(-100%);
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 100;
            overflow-y: auto;
            border-radius: 0 16px 16px 0;
            box-shadow: 2px 0 16px rgba(0, 0, 0, 0.05);
        }
        
        .sidebar.open {
            transform: translateX(0);
        }
        
        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sidebar-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        
        .close-sidebar {
            background: linear-gradient(135deg, #409eff 0%, #ff80ab 100%);
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: white;
            padding: 0;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(64, 158, 255, 0.2);
        }
        
        .close-sidebar:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(64, 158, 255, 0.3);
        }
        
        .chapter-list {
            padding: 12px 0;
        }
        
        .chapter-item {
            padding: 14px 24px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            border-radius: 0 8px 8px 0;
            margin: 0 12px;
        }
        
        .chapter-item:hover {
            background-color: #f8f9ff;
            border-left-color: #409eff;
            transform: translateX(4px);
        }
        
        .chapter-item.active {
            background-color: #e6f7ff;
            border-left-color: #409eff;
            color: #409eff;
        }
        
        /* ä¸»é˜…è¯»åŒºåŸŸ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            transition: margin-left 0.3s ease;
        }
        
        /* é¡¶éƒ¨æ§åˆ¶æ  */
        .top-bar {
            background-color: white;
            border-bottom: 1px solid #f0f0f0;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .left-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .back-btn {
            background: linear-gradient(135deg, #409eff 0%, #ff80ab 100%);
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(64, 158, 255, 0.2);
        }
        
        .back-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(64, 158, 255, 0.3);
        }
        
        .book-title {
            font-size: 16px;
            font-weight: 500;
            margin-left: 10px;
            color: #333;
        }
        
        .right-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .control-btn {
            background: white;
            border: 1px solid #e0e0e0;
            font-size: 16px;
            cursor: pointer;
            color: #666;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .control-btn:hover {
            border-color: #409eff;
            color: #409eff;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(64, 158, 255, 0.15);
        }
        
        /* é˜…è¯»åŒºåŸŸ */
        .reading-area {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            background-color: #f8f9ff;
            position: relative;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            /* éšè—æ»šåŠ¨æ¡ */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        /* éšè—æ»šåŠ¨æ¡ */
        .reading-area::-webkit-scrollbar {
            display: none;
        }
        
        .content-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            line-height: 1.8;
            will-change: transform;
            contain: content;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            /* éšè—æ»šåŠ¨æ¡ */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        /* éšè—æ»šåŠ¨æ¡ */
        .content-container::-webkit-scrollbar {
            display: none;
        }
        
        /* æ¸²æŸ“åŒºåŸŸä¼˜åŒ– */
        #epub-render-area {
            width: 100%;
            height: 100%;
            will-change: transform;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            /* éšè—æ»šåŠ¨æ¡ */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        /* éšè—æ»šåŠ¨æ¡ */
        #epub-render-area::-webkit-scrollbar {
            display: none;
        }
        
        /* åº•éƒ¨æ§åˆ¶æ  */
        .bottom-bar {
            background-color: white;
            border-top: 1px solid #f0f0f0;
            padding: 8px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 12px 12px 0 0;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
        }
        
        /* é˜…è¯»è®¾ç½®é¢æ¿ */
        .settings-panel {
            position: fixed;
            bottom: -300px;
            left: 0;
            right: 0;
            background-color: white;
            border-top: 1px solid #f0f0f0;
            padding: 24px;
            transition: bottom 0.3s ease;
            z-index: 50;
            border-radius: 16px 16px 0 0;
            box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.05);
        }
        
        .settings-panel.open {
            bottom: 0;
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .settings-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        
        .close-settings {
            background: linear-gradient(135deg, #409eff 0%, #ff80ab 100%);
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(64, 158, 255, 0.2);
        }
        
        .close-settings:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(64, 158, 255, 0.3);
        }
        
        .settings-group {
            margin-bottom: 20px;
        }
        
        .settings-label {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
            display: block;
        }
        
        .font-size-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .font-size-btn {
            background: none;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .font-size-value {
            min-width: 40px;
            text-align: center;
        }
        
        .theme-options {
            display: flex;
            gap: 10px;
        }
        
        .theme-option {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .theme-option.light {
            background-color: white;
            border: 1px solid #e8e8e8;
        }
        
        .theme-option.sepia {
            background-color: #f5f0e6;
        }
        

        
        .theme-option.active {
            border-color: #409eff;
        }
        
        /* é®ç½©å±‚ */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.3);
            z-index: 50;
            display: none;
        }
        
        .overlay.show {
            display: block;
        }
        
        /* å¯¼å…¥å¼¹çª— */
        .import-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .import-modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(64, 158, 255, 0.2);
            transform: scale(0.8) translateY(20px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        
        .import-modal.show .modal-content {
            transform: scale(1) translateY(0);
        }
        
        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #409eff 0%, #ff80ab 100%);
        }
        
        .modal-header {
            text-align: center;
            margin-bottom: 24px;
            position: relative;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #409eff 0%, #ff80ab 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .modal-subtitle {
            font-size: 14px;
            color: #666;
        }
        
        .close-btn {
            position: absolute;
            top: 0;
            right: 0;
            width: 32px;
            height: 32px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .close-btn:hover {
            background-color: #f0f0f0;
            color: #333;
        }
        
        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #666;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
            transform: translateY(-1px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #409eff 0%, #ff80ab 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(64, 158, 255, 0.2);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(64, 158, 255, 0.3);
        }
        
        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        /* PDF æ–‡æœ¬å±‚æ ·å¼ */
        .textLayer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            font-size: 12px;
            line-height: 1.2;
            pointer-events: auto;
        }
        
        .textLayer > div {
            position: absolute;
            white-space: pre;
            cursor: text;
            transform-origin: 0% 0%;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .reading-area {
                padding: 20px;
            }
            
            .content-container {
                padding: 20px;
            }
            
            .sidebar {
                width: 280px;
            }
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 20px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #409eff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* é”™è¯¯æç¤º */
        .error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 20px;
            text-align: center;
            padding: 40px;
        }
        
        .error-icon {
            font-size: 48px;
            color: #ff4d4f;
        }
        
        .error-message {
            font-size: 16px;
            color: #666;
        }
        
        .error-btn {
            background-color: #409eff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .error-btn:hover {
            background-color: #1890ff;
        }
        
        /* PDF é˜…è¯»å™¨æ ·å¼ */
        .pdf-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
        }
        
        .pdf-page {
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .pdf-page canvas {
            display: block;
            max-width: 100%;
        }
    </style>
</head>
<body>
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">ç« èŠ‚åˆ—è¡¨</div>
            <button class="close-sidebar" id="close-sidebar">Ã—</button>
        </div>
        <div class="chapter-list" id="chapter-list">
            <!-- ç« èŠ‚åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
    
    <!-- é®ç½©å±‚ -->
    <div class="overlay" id="overlay"></div>
    
    <!-- ä¸»é˜…è¯»åŒºåŸŸ -->
    <div class="reader-container">
        <div class="main-content">
            <!-- é¡¶éƒ¨æ§åˆ¶æ  -->
            <div class="top-bar">
                <div class="left-controls">
                    <button class="back-btn" id="back-btn">â†</button>
                    <div class="book-title" id="book-title">ä¹¦ç±æ ‡é¢˜</div>
                </div>
                <div class="right-controls">
                    <button class="control-btn" id="notes-btn">ğŸ“</button>
                    <button class="control-btn" id="toc-btn">ğŸ“‘</button>
                    <button class="control-btn" id="settings-btn">âš™ï¸</button>
                </div>
            </div>
            
            <!-- é˜…è¯»åŒºåŸŸ -->
            <div class="reading-area" id="reading-area">
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <div>åŠ è½½ä¸­...</div>
                </div>
                <div class="error" id="error" style="display: none;">
                    <div class="error-icon">ğŸ“š</div>
                    <div class="error-message" id="error-message">æ— æ³•åŠ è½½ä¹¦ç±</div>
                    <button class="error-btn" id="retry-btn">é‡è¯•</button>
                </div>
                <div class="content-container" id="content-container" style="display: none;">
                    <!-- ä¹¦ç±å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- åº•éƒ¨æ§åˆ¶æ  -->
            <div class="bottom-bar">
            </div>
        </div>
    </div>
    
    <!-- é˜…è¯»è®¾ç½®é¢æ¿ -->
    <div class="settings-panel" id="settings-panel">
        <div class="settings-header">
            <div class="settings-title">é˜…è¯»è®¾ç½®</div>
            <button class="close-settings" id="close-settings">Ã—</button>
        </div>

        <div class="settings-group">
            <label class="settings-label">ä¸»é¢˜</label>
            <div class="theme-options">
                <div class="theme-option light active" data-theme="light"></div>
                <div class="theme-option sepia" data-theme="sepia"></div>
            </div>
        </div>
        
        <div class="settings-group">
            <label class="settings-label">ç¿»è¯‘åŠŸèƒ½</label>
            <button id="translate-btn" style="background: linear-gradient(135deg, #409eff 0%, #ff80ab 100%); border: none; color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-size: 14px; font-weight: 500; box-shadow: 0 2px 8px rgba(64, 158, 255, 0.2);">
                æ‰“å¼€ç¿»è¯‘å·¥å…·
            </button>
        </div>
    </div>
    
    <!-- æ–‡æœ¬é€‰æ‹©èœå• -->
    <div class="selection-menu" id="selection-menu" style="position: fixed; background: white; border-radius: 8px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1); z-index: 1000; display: none; padding: 4px 0;">
        <div class="menu-item" id="menu-copy" style="padding: 8px 16px; cursor: pointer; font-size: 14px; transition: background-color 0.2s ease;">å¤åˆ¶</div>
        <div class="menu-item" id="menu-add-note" style="padding: 8px 16px; cursor: pointer; font-size: 14px; transition: background-color 0.2s ease;">æ·»åŠ æ‰¹æ³¨</div>
    </div>
    
    <!-- æ‰¹æ³¨å¼¹çª— -->
    <div class="import-modal" id="note-popup">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">æ·»åŠ æ‰¹æ³¨</h2>
                <p class="modal-subtitle">é€‰æ‹©è§å…‰ç¬”é¢œè‰²å¹¶æ·»åŠ æ‰¹æ³¨å†…å®¹</p>
                <button class="close-btn" id="cancel-note">Ã—</button>
            </div>
            <div style="margin-bottom: 24px;">
                <label class="settings-label" style="margin-bottom: 12px; display: block;">è§å…‰ç¬”é¢œè‰²</label>
                <div class="highlighter-colors" style="display: flex; gap: 12px; margin-bottom: 20px;">
                    <div class="color-option" data-color="#ffff00" style="width: 40px; height: 40px; border-radius: 50%; background-color: #ffff00; border: 2px solid transparent; cursor: pointer; transition: all 0.3s ease;"></div>
                    <div class="color-option" data-color="#ff6b6b" style="width: 40px; height: 40px; border-radius: 50%; background-color: #ff6b6b; border: 2px solid transparent; cursor: pointer; transition: all 0.3s ease;"></div>
                    <div class="color-option" data-color="#4ecdc4" style="width: 40px; height: 40px; border-radius: 50%; background-color: #4ecdc4; border: 2px solid transparent; cursor: pointer; transition: all 0.3s ease;"></div>
                    <div class="color-option" data-color="#45b7d1" style="width: 40px; height: 40px; border-radius: 50%; background-color: #45b7d1; border: 2px solid transparent; cursor: pointer; transition: all 0.3s ease;"></div>
                    <div class="color-option" data-color="#96ceb4" style="width: 40px; height: 40px; border-radius: 50%; background-color: #96ceb4; border: 2px solid transparent; cursor: pointer; transition: all 0.3s ease;"></div>
                </div>
                <label class="settings-label" style="margin-bottom: 12px; display: block;">æ‰¹æ³¨å†…å®¹</label>
                <textarea id="note-content" style="width: 100%; min-height: 120px; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; resize: vertical; font-family: inherit; font-size: 14px; line-height: 1.5; transition: all 0.3s ease;"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancel-note-btn">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="save-note">ä¿å­˜æ‰¹æ³¨</button>
            </div>
        </div>
    </div>
    
    <!-- æ‰¹æ³¨ç®¡ç†é¢æ¿ -->
    <div class="sidebar" id="notes-sidebar" style="width: 300px; background-color: white; border-right: 1px solid #f0f0f0; transition: transform 0.3s ease; transform: translateX(-100%); position: fixed; left: 0; top: 0; bottom: 0; z-index: 150; overflow-y: auto; border-radius: 0 16px 16px 0; box-shadow: 2px 0 16px rgba(0, 0, 0, 0.05);">
        <div class="sidebar-header">
            <div class="sidebar-title">æˆ‘çš„æ‰¹æ³¨</div>
            <button class="close-sidebar" id="close-notes-sidebar">Ã—</button>
        </div>
        <div class="notes-list" id="notes-list" style="padding: 12px 0;">
            <!-- æ‰¹æ³¨åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
    
    <script>
        // å…¨å±€å˜é‡
        let currentBook = null;
        let currentChapter = 0;
        let chapters = [];
        let currentTheme = 'light';
        let epubBook = null;
        let epubRenderer = null;
        let rendererInitialized = false; // æ¸²æŸ“å™¨åˆå§‹åŒ–çŠ¶æ€
        let pdfDoc = null;
        let pdfPageNum = 1;
        let pdfScale = 1.5;
        let pdfRendering = false;
        let annotations = []; // æ‰¹æ³¨æ•°æ®
        let selectedColor = '#ffff00'; // é»˜è®¤è§å…‰ç¬”é¢œè‰²
        let contentCheckInterval = null; // å†…å®¹æ£€æŸ¥å®šæ—¶å™¨
        let selectedText = ''; // é€‰ä¸­çš„æ–‡æœ¬
        let selectionRange = null; // é€‰ä¸­æ–‡æœ¬çš„èŒƒå›´
        
        // Base64 è½¬ ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }
        
        // æå– EPUB å°é¢
        async function extractEPUBCover(arrayBuffer) {
            try {
                console.log('å¼€å§‹æå–EPUBå°é¢...');
                
                // åˆ›å»º EPUB å¯¹è±¡
                const epubBook = ePub(arrayBuffer);
                
                // ç­‰å¾… EPUB åŠ è½½å®Œæˆ
                await epubBook.ready;
                
                // å°è¯•è·å–å°é¢
                let coverUrl = await epubBook.coverUrl();
                
                if (coverUrl) {
                    console.log('å°é¢URLè·å–æˆåŠŸ:', coverUrl);
                    
                    // å°†å°é¢URLè½¬æ¢ä¸ºBase64ä»¥ä¾¿æ˜¾ç¤º
                    const response = await fetch(coverUrl);
                    const blob = await response.blob();
                    
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                } else {
                    console.log('æ ‡å‡†å°é¢è·å–å¤±è´¥ï¼Œå°è¯•ä»ç¬¬ä¸€ç« æå–');
                    // å°è¯•ä»ç¬¬ä¸€ç« æå–å°é¢
                    try {
                        // è·å–ç›®å½•
                        const spine = await epubBook.loaded.spine;
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰ç« èŠ‚
                        if (spine && (Array.isArray(spine) || (spine.items && Array.isArray(spine.items)))) {
                            let spineItems = Array.isArray(spine) ? spine : spine.items;
                            
                            if (spineItems.length > 0) {
                                // è·å–ç¬¬ä¸€ä¸ªç« èŠ‚
                                const firstChapter = spineItems[0];
                                const chapterItem = firstChapter.item || firstChapter;
                                const chapterHref = chapterItem.href || chapterItem.src || chapterItem.url;
                                
                                if (chapterHref) {
                                    console.log('å°è¯•åŠ è½½ç¬¬ä¸€ç« å†…å®¹:', chapterHref);
                                    // åŠ è½½ç¬¬ä¸€ç« å†…å®¹
                                    const documentObj = await epubBook.load(chapterHref);
                                    
                                    if (documentObj && (documentObj instanceof XMLDocument || documentObj instanceof HTMLDocument)) {
                                        // æŸ¥æ‰¾ç¬¬ä¸€ç« ä¸­çš„å›¾ç‰‡
                                        let images = [];
                                        if (documentObj.body) {
                                            images = Array.from(documentObj.body.querySelectorAll('img'));
                                        } else if (documentObj.documentElement) {
                                            images = Array.from(documentObj.documentElement.querySelectorAll('img'));
                                        }
                                        
                                        if (images.length > 0) {
                                            console.log('ä»ç¬¬ä¸€ç« æ‰¾åˆ°å›¾ç‰‡:', images.length, 'å¼ ');
                                            // ä½¿ç”¨ç¬¬ä¸€å¼ å›¾ç‰‡ä½œä¸ºå°é¢
                                            const firstImage = images[0];
                                            let imageSrc = firstImage.src;
                                            
                                            // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œå°è¯•æ„å»ºå®Œæ•´è·¯å¾„
                                            if (!imageSrc.startsWith('http')) {
                                                // å°è¯•ä»EPUBä¸­è·å–å®Œæ•´è·¯å¾„
                                                try {
                                                    const imageResponse = await fetch(imageSrc);
                                                    const imageBlob = await imageResponse.blob();
                                                    
                                                    return new Promise((resolve, reject) => {
                                                        const reader = new FileReader();
                                                        reader.onloadend = () => resolve(reader.result);
                                                        reader.onerror = reject;
                                                        reader.readAsDataURL(imageBlob);
                                                    });
                                                } catch (imageError) {
                                                    console.warn('æ— æ³•åŠ è½½å›¾ç‰‡:', imageError);
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    } catch (chapterError) {
                        console.warn('ä»ç¬¬ä¸€ç« æå–å°é¢å¤±è´¥:', chapterError);
                    }
                    
                    console.log('EPUBæ–‡ä»¶æ²¡æœ‰æ‰¾åˆ°å°é¢');
                    return null;
                }
            } catch (error) {
                console.error('æå–EPUBå°é¢å¤±è´¥:', error);
                return null;
            }
        }
        
        // å…¨å±€å˜é‡
        let isSelectingText = false;
        let selectionMenuTimeout = null;
        
        // åˆå§‹åŒ–
        function init() {
            // åŠ è½½å½“å‰ä¹¦ç±
            loadCurrentBook();
            
            // åŠ è½½æ‰¹æ³¨
            loadAnnotations();
            
            // åº”ç”¨è®¾ç½®ï¼Œç¡®ä¿æ–‡æœ¬é€‰æ‹©èœå•çš„æ ·å¼è¢«æ­£ç¡®è®¾ç½®
            applySettings();
            
            // æ˜¾ç¤ºæ‰¹æ³¨é«˜äº®æ•ˆæœ
            highlightAnnotations();
            
            // ç»‘å®šäº‹ä»¶
            bindEvents();
            
            // å®šæœŸæ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„iframeï¼ˆEPUBå†…å®¹ï¼‰è¢«æ·»åŠ 
            setInterval(function() {
                checkForEPUBIframe();
            }, 1000);
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰EPUB iframeè¢«æ·»åŠ 
        function checkForEPUBIframe() {
            // æŸ¥æ‰¾æ‰€æœ‰iframe
            const iframes = document.querySelectorAll('iframe');
            iframes.forEach(function(iframe) {
                // æ£€æŸ¥iframeæ˜¯å¦å·²ç»æ·»åŠ äº†äº‹ä»¶ç›‘å¬å™¨
                if (!iframe.hasSelectionListener) {
                    console.log('æ‰¾åˆ°EPUB iframeï¼Œæ·»åŠ äº‹ä»¶ç›‘å¬å™¨');
                    try {
                        // å°è¯•è®¿é—®iframeçš„å†…å®¹
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        if (iframeDoc) {
                            // æ·»åŠ é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶ç›‘å¬å™¨ - æ ‡è®°å¼€å§‹é€‰æ‹©æ–‡æœ¬
                            iframeDoc.addEventListener('mousedown', function(e) {
                                isSelectingText = true;
                                console.log('iframeé¼ æ ‡æŒ‰ä¸‹ï¼Œå¼€å§‹é€‰æ‹©æ–‡æœ¬');
                            });
                            
                            // æ·»åŠ é¼ æ ‡é‡Šæ”¾äº‹ä»¶ç›‘å¬å™¨ - åªåœ¨é¼ æ ‡é‡Šæ”¾æ—¶æ£€æŸ¥ï¼Œç¡®ä¿èœå•åªåœ¨ç”¨æˆ·æ¾å¼€é¼ æ ‡ä¸”é€‰æ‹©äº†æ–‡æœ¬çš„æƒ…å†µä¸‹æ˜¾ç¤º
                            iframeDoc.addEventListener('mouseup', function(e) {
                                if (isSelectingText) {
                                    console.log('iframeé¼ æ ‡é‡Šæ”¾ï¼Œæ£€æŸ¥æ–‡æœ¬é€‰æ‹©');
                                    // å»¶è¿Ÿä¸€ä¸‹ï¼Œç¡®ä¿é€‰æ‹©å·²ç»å®Œæˆ
                                    setTimeout(function() {
                                        handleTextSelection();
                                        // å»¶è¿Ÿæ›´é•¿æ—¶é—´é‡ç½®isSelectingTextï¼Œç¡®ä¿ç‚¹å‡»äº‹ä»¶å¤„ç†å®Œæˆ
                                        setTimeout(function() {
                                            isSelectingText = false;
                                        }, 200);
                                    }, 50);
                                }
                            });
                            
                            // ç§»é™¤ selectionchange äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…åœ¨é€‰æ‹©è¿‡ç¨‹ä¸­å¤šæ¬¡è§¦å‘
                            // iframeDoc.addEventListener('selectionchange', function(e) {
                            //     console.log('iframeæ–‡æœ¬é€‰æ‹©å˜åŒ–');
                            //     handleTextSelection();
                            // });
                            
                            // æ ‡è®°iframeå·²ç»æ·»åŠ äº†äº‹ä»¶ç›‘å¬å™¨
                            iframe.hasSelectionListener = true;
                        }
                    } catch (error) {
                        console.error('æ— æ³•è®¿é—®iframeå†…å®¹:', error);
                    }
                }
            });
        }
        
        // æ¸…ç†å‡½æ•°
        function cleanup() {
            // æ¸…ç†ä»»ä½•éœ€è¦æ¸…ç†çš„èµ„æº
            console.log('é¡µé¢æ¸…ç†å®Œæˆ');
        }
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('unload', cleanup);
        window.addEventListener('beforeunload', cleanup);
        
        // åŠ è½½å½“å‰ä¹¦ç±
        function loadCurrentBook() {
            const bookData = localStorage.getItem('godReaderCurrentBook');
            if (!bookData) {
                showError('æœªæ‰¾åˆ°ä¹¦ç±ä¿¡æ¯ï¼Œè¯·è¿”å›é‡æ–°é€‰æ‹©');
                return;
            }
            
            currentBook = JSON.parse(bookData);
            document.getElementById('book-title').textContent = currentBook.title;
            
            // æ ¹æ®æ–‡ä»¶æ ¼å¼åŠ è½½
            if (currentBook.format === 'txt') {
                // TXTæ–‡ä»¶ç›´æ¥åŠ è½½å†…å®¹
                loadBookContent();
            } else if (currentBook.format === 'pdf') {
                // PDFæ–‡ä»¶åŠ è½½
                loadPDFFile();
            } else {
                // EPUBæ–‡ä»¶ä½¿ç”¨EPUB.jsåŠ è½½
                loadEPUBFile();
            }
        }
        
        // åŠ è½½ EPUB æ–‡ä»¶
        function loadEPUBFile() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            
            loading.style.display = 'flex';
            error.style.display = 'none';
            
            // é‡ç½® EPUB ç›¸å…³å˜é‡
            epubBook = null;
            epubRenderer = null;
            chapters = [];
            
            try {
                // æ£€æŸ¥æ˜¯å¦æœ‰ EPUB æ–‡ä»¶æ•°æ®
                if (!currentBook.fileData) {
                    showError('æœªæ‰¾åˆ° EPUB æ–‡ä»¶æ•°æ®ï¼Œè¯·è¿”å›é‡æ–°é€‰æ‹©ä¹¦ç±');
                    console.error('ç¼ºå°‘æ–‡ä»¶æ•°æ®:', currentBook);
                    return;
                }
                
                console.log('å¼€å§‹åŠ è½½EPUBæ–‡ä»¶:', currentBook.title);
                console.log('æ–‡ä»¶æ•°æ®ç±»å‹:', typeof currentBook.fileData);
                console.log('æ–‡ä»¶æ•°æ®é•¿åº¦:', currentBook.fileData ? currentBook.fileData.length : 'N/A');
                console.log('æ•°æ®ç±»å‹æ ‡è®°:', currentBook.dataType);
                
                // å¤„ç†æ–‡ä»¶æ•°æ®æ ¼å¼
                let epubData = currentBook.fileData;
                if (currentBook.dataType === 'base64') {
                    console.log('å¤„ç† Base64 æ ¼å¼æ•°æ®');
                    try {
                        // ä¼˜åŒ– Base64 è½¬ ArrayBuffer çš„æ€§èƒ½
                        epubData = base64ToArrayBuffer(currentBook.fileData);
                        console.log('Base64 è½¬ ArrayBuffer æˆåŠŸï¼Œè½¬æ¢åé•¿åº¦:', epubData.byteLength);
                    } catch (base64Error) {
                        console.error('Base64 è½¬æ¢å¤±è´¥:', base64Error);
                        showError('EPUB æ–‡ä»¶æ•°æ®æ ¼å¼é”™è¯¯: ' + base64Error.message);
                        return;
                    }
                } else if (typeof currentBook.fileData === 'object' && currentBook.fileData !== null) {
                    console.log('æ£€æµ‹åˆ°å¯èƒ½çš„æ—§æ ¼å¼æ•°æ®ï¼Œå°è¯•å¤„ç†');
                    showError('EPUB æ–‡ä»¶æ•°æ®æ ¼å¼è¿‡æ—¶ï¼Œè¯·é‡æ–°å¯¼å…¥ä¹¦ç±');
                    return;
                } else if (typeof currentBook.fileData === 'string' && currentBook.dataType !== 'base64') {
                    console.log('æ£€æµ‹åˆ°å¯èƒ½çš„æ–‡æœ¬æ ¼å¼æ•°æ®');
                    showError('EPUB æ–‡ä»¶æ•°æ®æ ¼å¼é”™è¯¯ï¼Œè¯·é‡æ–°å¯¼å…¥ä¹¦ç±');
                    return;
                }
                
                // è®°å½•å¼€å§‹æ—¶é—´ï¼Œç”¨äºæ€§èƒ½è¯„ä¼°
                const startTime = performance.now();
                
                // åˆå§‹åŒ– EPUB ä¹¦ç±
                try {
                    // ä»æ–‡ä»¶æ•°æ®åŠ è½½ï¼ˆArrayBufferï¼‰
                    epubBook = ePub(epubData);
                    console.log('EPUBå¯¹è±¡åˆ›å»ºæˆåŠŸ');
                    
                    // å¹¶è¡Œå¤„ç†ï¼šå°é¢æå–ä¸EPUBè§£æ
                    const coverPromise = extractEPUBCover(epubData);
                    
                    // è§£æ EPUB ä¹¦ç±
                    Promise.all([
                        epubBook.loaded.metadata,
                        epubBook.loaded.spine,
                        coverPromise
                    ]).then(function(results) {
                        const metadata = results[0];
                        const spine = results[1];
                        const coverUrl = results[2];
                        
                        console.log('å…ƒæ•°æ®åŠ è½½æˆåŠŸ:', metadata);
                        // æ›´æ–°ä¹¦ç±æ ‡é¢˜
                        if (metadata.title) {
                            document.getElementById('book-title').textContent = metadata.title;
                        }
                        
                        // å¤„ç†å°é¢
                        if (coverUrl) {
                            console.log('å°é¢æå–æˆåŠŸï¼Œè®¾ç½®å°é¢');
                            // ä¿å­˜å°é¢åˆ°currentBookå¯¹è±¡
                            currentBook.cover = coverUrl;
                        }
                        
                        console.log('ç›®å½•åŠ è½½æˆåŠŸï¼Œspineç±»å‹:', typeof spine);
                        console.log('spineå€¼:', spine);
                        
                        // å¤„ç†ä¸åŒç±»å‹çš„ spine ç»“æ„
                        let spineItems = [];
                        
                        if (Array.isArray(spine)) {
                            // æ ‡å‡†æ•°ç»„æ ¼å¼
                            spineItems = spine;
                        } else if (spine && typeof spine === 'object') {
                            // å¯èƒ½æ˜¯å¯¹è±¡æ ¼å¼ï¼Œå°è¯•è·å– items å±æ€§
                            if (spine.items && Array.isArray(spine.items)) {
                                spineItems = spine.items;
                                console.log('ä½¿ç”¨ spine.items ä½œä¸ºç« èŠ‚åˆ—è¡¨');
                            } else if (spine.spine && Array.isArray(spine.spine)) {
                                spineItems = spine.spine;
                                console.log('ä½¿ç”¨ spine.spine ä½œä¸ºç« èŠ‚åˆ—è¡¨');
                            } else if (spine.length !== undefined) {
                                // ç±»ä¼¼æ•°ç»„çš„å¯¹è±¡
                                console.log('å¤„ç†ç±»ä¼¼æ•°ç»„çš„å¯¹è±¡');
                                for (let i = 0; i < spine.length; i++) {
                                    if (spine[i]) {
                                        spineItems.push(spine[i]);
                                    }
                                }
                            } else {
                                console.error('æ— æ³•è¯†åˆ«çš„ spine ç»“æ„:', spine);
                                showError('EPUB æ–‡ä»¶ç»“æ„é”™è¯¯ï¼Œæ— æ³•è§£æç« èŠ‚ä¿¡æ¯');
                                return;
                            }
                        } else {
                            console.error('æ— æ•ˆçš„ spine æ•°æ®:', spine);
                            showError('EPUB æ–‡ä»¶ç»“æ„é”™è¯¯ï¼Œæ— æ³•è§£æç« èŠ‚ä¿¡æ¯');
                            return;
                        }
                        
                        console.log('ç« èŠ‚æ•°é‡:', spineItems.length);
                        
                        // æ£€æŸ¥ç« èŠ‚æ•°é‡
                        if (spineItems.length === 0) {
                            showError('EPUB æ–‡ä»¶æ²¡æœ‰æ‰¾åˆ°ç« èŠ‚å†…å®¹');
                            return;
                        }
                        
                        // ç”Ÿæˆç« èŠ‚åˆ—è¡¨
                        chapters = [];
                        spineItems.forEach(function(item, index) {
                            console.log('ç« èŠ‚é¡¹:', index, item);
                            
                            // å¤„ç†ä¸åŒæ ¼å¼çš„ç« èŠ‚é¡¹
                            let chapterItem = item;
                            if (item.item) {
                                // å¯èƒ½æ˜¯åŒ…è£…æ ¼å¼
                                chapterItem = item.item;
                                console.log('ä½¿ç”¨ item.item ä½œä¸ºç« èŠ‚é¡¹');
                            }
                            
                            // å°è¯•è·å–ç« èŠ‚æ ‡é¢˜
                            let chapterTitle = chapterItem.id;
                            if (!chapterTitle && chapterItem.properties) {
                                chapterTitle = chapterItem.properties.title;
                            }
                            if (!chapterTitle && chapterItem.title) {
                                chapterTitle = chapterItem.title;
                            }
                            if (!chapterTitle) {
                                chapterTitle = `ç¬¬${index + 1}ç« `;
                            }
                            
                            // å°è¯•è·å– href
                            let href = chapterItem.href;
                            if (!href && chapterItem.src) {
                                href = chapterItem.src;
                            }
                            if (!href && chapterItem.url) {
                                href = chapterItem.url;
                            }
                            
                            // ç¡®ä¿ href å­˜åœ¨
                            if (!href) {
                                console.warn('ç« èŠ‚é¡¹ç¼ºå°‘ href:', chapterItem);
                                chapterTitle += ' (æ— å†…å®¹)';
                            }
                            
                            chapters.push({
                                id: index,
                                title: chapterTitle,
                                href: href || ''
                            });
                        });
                        
                        // æ¸²æŸ“ç« èŠ‚åˆ—è¡¨
                        renderChapterList();
                        
                        // ç›´æ¥ä½¿ç”¨ EPUB.js æ ‡å‡†æ–¹å¼åŠ è½½å†…å®¹
                        loadEPUBContentStandard(coverUrl, 0);
                        
                        // è®°å½•ç»“æŸæ—¶é—´å¹¶è®¡ç®—è§£ææ—¶é—´
                        const endTime = performance.now();
                        console.log(`EPUB è§£ææ—¶é—´: ${(endTime - startTime).toFixed(2)}ms`);
                    }).catch(function(error) {
                        console.error('EPUB è§£æé”™è¯¯:', error);
                        console.error('é”™è¯¯è¯¦æƒ…:', error.stack);
                        let errorMessage = 'è§£æ EPUB æ–‡ä»¶å¤±è´¥';
                        
                        // æ ¹æ®é”™è¯¯ç±»å‹æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                        if (error.message && error.message.includes('unzip')) {
                            errorMessage += 'ï¼Œæ–‡ä»¶å¯èƒ½æŸåæˆ–ä¸æ˜¯æœ‰æ•ˆçš„ EPUB æ–‡ä»¶';
                        } else if (error.message && error.message.includes('parse')) {
                            errorMessage += 'ï¼Œæ–‡ä»¶æ ¼å¼é”™è¯¯';
                        } else if (error.message && error.message.includes('network')) {
                            errorMessage += 'ï¼Œç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                        } else if (error.message) {
                            errorMessage += ': ' + error.message;
                        }
                        
                        showError(errorMessage);
                    });
                } catch (initError) {
                    console.error('EPUBåˆå§‹åŒ–å¤±è´¥:', initError);
                    let errorMessage = 'EPUBæ–‡ä»¶åˆå§‹åŒ–å¤±è´¥';
                    if (initError.message) {
                        errorMessage += ': ' + initError.message;
                    }
                    showError(errorMessage);
                    return;
                }
            } catch (error) {
                console.error('EPUB åŠ è½½é”™è¯¯:', error);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                let errorMessage = 'åŠ è½½ EPUB æ–‡ä»¶å¤±è´¥';
                
                if (error.name === 'TypeError') {
                    errorMessage += 'ï¼Œæ–‡ä»¶ç±»å‹é”™è¯¯';
                } else if (error.name === 'SecurityError') {
                    errorMessage += 'ï¼Œå®‰å…¨é™åˆ¶ï¼Œæ— æ³•è®¿é—®æ–‡ä»¶';
                } else if (error.name === 'RangeError') {
                    errorMessage += 'ï¼Œæ–‡ä»¶æ•°æ®è¶…å‡ºå¤„ç†èŒƒå›´';
                } else if (error.message) {
                    errorMessage += ': ' + error.message;
                }
                
                showError(errorMessage);
            }
        }
        
        // ç®€åŒ–çš„ EPUB å†…å®¹åŠ è½½æ–¹æ³•
        function loadEPUBContentSimple(coverUrl) {
            const loading = document.getElementById('loading');
            const contentContainer = document.getElementById('content-container');
            
            try {
                // æ¸…ç©ºå®¹å™¨
                contentContainer.innerHTML = '';
                
                // ç¡®ä¿å®¹å™¨æœ‰æ­£ç¡®çš„å°ºå¯¸
                contentContainer.style.width = '100%';
                contentContainer.style.height = '100%';
                contentContainer.style.minHeight = '600px';
                contentContainer.style.position = 'relative';
                contentContainer.style.overflow = 'auto';
                contentContainer.style.padding = '20px';
                contentContainer.style.backgroundColor = 'white';
                contentContainer.style.borderRadius = '8px';
                contentContainer.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
                
                console.log('å¼€å§‹ä½¿ç”¨ç®€åŒ–æ–¹æ³•åŠ è½½EPUBå†…å®¹');
                
                // ä¸å†é»˜è®¤æ˜¾ç¤ºå°é¢ï¼Œç›´æ¥æ˜¾ç¤ºä¹¦ç±å†…å®¹
                console.log('ç›´æ¥æ˜¾ç¤ºä¹¦ç±å†…å®¹ï¼Œä¸æ·»åŠ å°é¢');

                // åˆ›å»ºä¸€ä¸ªç®€å•çš„æ¸²æŸ“åŒºåŸŸ
                const renderArea = document.createElement('div');
                renderArea.id = 'epub-render-area';
                renderArea.style.width = '100%';
                renderArea.style.height = '100%';
                contentContainer.appendChild(renderArea);
                
                // ä½¿ç”¨ EPUB.js çš„æ¸²æŸ“å™¨ï¼Œé…ç½®ä¸ºæ»šåŠ¨ç¿»é¡µæ¨¡å¼
                try {
                    // é…ç½®ä¸ºæ»šåŠ¨ç¿»é¡µæ¨¡å¼
                    epubRenderer = epubBook.renderTo(renderArea, {
                        width: '100%',
                        height: '100%',
                        manager: 'continuous',
                        flow: 'scrolled-continuous',
                        spread: 'none',
                        stylesheet: true,
                        script: false // ç¦ç”¨è„šæœ¬ä»¥æé«˜æ€§èƒ½
                    });
                    
                    console.log('EPUB.js renderTo è°ƒç”¨å®Œæˆï¼Œæ¸²æŸ“å™¨:', epubRenderer);
                    
                    // ç«‹å³æ˜¾ç¤ºå†…å®¹å®¹å™¨
                    contentContainer.style.display = 'block';
                    
                    // ç›‘å¬æ¸²æŸ“å®Œæˆäº‹ä»¶
                    if (epubRenderer && typeof epubRenderer.on === 'function') {
                        epubRenderer.on('rendered', function() {
                            console.log('EPUBå†…å®¹æ¸²æŸ“å®Œæˆ');
                            loading.style.display = 'none';
                            applySettings();
                        });
                        
                        // ç›‘å¬é”™è¯¯äº‹ä»¶
                        epubRenderer.on('error', function(error) {
                            console.error('EPUBæ¸²æŸ“é”™è¯¯:', error);
                            loading.style.display = 'none';
                            showError('EPUBå†…å®¹æ¸²æŸ“å¤±è´¥: ' + error.message);
                        });
                        

                        
                        // æ·»åŠ è¶…æ—¶å¤„ç†ï¼Œç¡®ä¿åŠ è½½åŠ¨ç”»ä¸ä¼šä¸€ç›´æ˜¾ç¤º
                        setTimeout(() => {
                            if (loading.style.display !== 'none') {
                                console.log('æ¸²æŸ“äº‹ä»¶æœªè§¦å‘ï¼Œæ‰‹åŠ¨éšè—åŠ è½½åŠ¨ç”»');
                                loading.style.display = 'none';
                                // æ£€æŸ¥æ˜¯å¦æœ‰å†…å®¹
                                if (renderArea.innerHTML.trim() === '') {
                                    console.error('æ¸²æŸ“åŒºåŸŸä¸ºç©ºï¼Œå°è¯•ç›´æ¥åŠ è½½ç« èŠ‚');
                                    // æ¸…ç©ºå®¹å™¨å¹¶ç›´æ¥åŠ è½½ç« èŠ‚
                                    contentContainer.innerHTML = '';
                                    loadFirstChapterDirectly();
                                } else {
                                    console.log('æ¸²æŸ“åŒºåŸŸæœ‰å†…å®¹ï¼Œåº”ç”¨è®¾ç½®');
                                    applySettings();
                                }
                            }
                        }, 3000);
                    } else {
                        console.error('æ¸²æŸ“å™¨å¯¹è±¡æ— æ•ˆæˆ–ç¼ºå°‘onæ–¹æ³•:', epubRenderer);
                        // ç›´æ¥å®ŒæˆåŠ è½½
                        loading.style.display = 'none';
                        contentContainer.style.display = 'block';
                        // æ£€æŸ¥æ˜¯å¦æœ‰å†…å®¹
                        if (renderArea.innerHTML.trim() === '') {
                            console.error('æ¸²æŸ“åŒºåŸŸä¸ºç©ºï¼Œå°è¯•ç›´æ¥åŠ è½½ç« èŠ‚');
                            loadFirstChapterDirectly();
                        }
                    }
                } catch (renderError) {
                    console.error('åˆ›å»ºæ¸²æŸ“å™¨å¤±è´¥:', renderError);
                    // æ¸²æŸ“å™¨åˆ›å»ºå¤±è´¥ï¼Œå°è¯•ç›´æ¥åŠ è½½ç« èŠ‚
                    loading.style.display = 'none';
                    contentContainer.style.display = 'block';
                    loadFirstChapterDirectly();
                }
                
            } catch (error) {
                console.error('ç®€åŒ–æ–¹æ³•åŠ è½½EPUBå†…å®¹å¤±è´¥:', error);
                loading.style.display = 'none';
                showError('EPUBå†…å®¹åŠ è½½å¤±è´¥: ' + error.message);
            }
        }
        
        // ä½¿ç”¨ EPUB.js æ ‡å‡†æ–¹å¼åŠ è½½å†…å®¹
        function loadEPUBContentStandard(coverUrl, targetChapterIndex) {
            // å¦‚æœæŒ‡å®šäº†ç›®æ ‡ç« èŠ‚ç´¢å¼•ï¼Œä½¿ç”¨å®ƒ
            const chapterIndex = targetChapterIndex !== undefined ? targetChapterIndex : currentChapter;
            const loading = document.getElementById('loading');
            const contentContainer = document.getElementById('content-container');
            
            try {
                // æ¸…ç©ºå®¹å™¨
                contentContainer.innerHTML = '';
                
                // ç¡®ä¿å®¹å™¨æœ‰æ­£ç¡®çš„å°ºå¯¸
                contentContainer.style.width = '100%';
                contentContainer.style.height = '100%';
                contentContainer.style.minHeight = '600px';
                contentContainer.style.position = 'relative';
                contentContainer.style.overflow = 'auto';
                contentContainer.style.padding = '20px';
                contentContainer.style.backgroundColor = 'white';
                contentContainer.style.borderRadius = '8px';
                contentContainer.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
                
                console.log('å¼€å§‹ä½¿ç”¨æ ‡å‡†æ–¹å¼åŠ è½½EPUBå†…å®¹');
                
                // åˆ›å»ºæ¸²æŸ“åŒºåŸŸ
                const renderArea = document.createElement('div');
                renderArea.id = 'epub-render-area';
                renderArea.style.width = '100%';
                renderArea.style.height = '100%';
                contentContainer.appendChild(renderArea);
                
                // ç«‹å³æ˜¾ç¤ºå†…å®¹å®¹å™¨
                contentContainer.style.display = 'block';
                
                // ä½¿ç”¨ EPUB.js æ ‡å‡†æ¸²æŸ“å™¨
                try {
                    // ä¼˜åŒ–é…ç½®ï¼Œæé«˜æ»šåŠ¨æ€§èƒ½
                    epubRenderer = epubBook.renderTo(renderArea, {
                        width: '100%',
                        height: '100%',
                        manager: 'continuous',
                        flow: 'scrolled-continuous',
                        spread: 'none',
                        stylesheet: true,
                        script: false,
                        // ç¡®ä¿å¯ç”¨è¿ç»­æ»šåŠ¨
                        continuous: true,
                        // å¯ç”¨ç« èŠ‚ä¹‹é—´çš„è¿ç»­æ»šåŠ¨
                        seamless: true,
                        // æ€§èƒ½ä¼˜åŒ–
                        timeout: 3000,
                        // é¢„åŠ è½½è®¾ç½®
                        preload: true,
                        // å‡å°‘é‡ç»˜
                        ignoreClass: 'ignore',
                        // å¹³æ»‘æ»šåŠ¨
                        smoothScroll: true,
                        // å‡å°‘å¸ƒå±€è®¡ç®—
                        layout: false,
                        // ç¦ç”¨ä¸å¿…è¦çš„åŠ¨ç”»
                        animations: false,
                        // å‡å°‘å†…å­˜ä½¿ç”¨
                        memoryLimit: 100,
                        // ç¦ç”¨è‡ªåŠ¨è°ƒæ•´å¤§å°
                        autoResize: false,
                        // ç¦ç”¨ä¸å¿…è¦çš„äº‹ä»¶
                        events: false
                    });
                    
                    console.log('EPUB.js æ ‡å‡†æ¸²æŸ“å™¨åˆ›å»ºæˆåŠŸ:', epubRenderer);
                    
                    // åŠ è½½æ•´æœ¬ä¹¦ï¼Œå¯ç”¨è¿ç»­æ»šåŠ¨
                    console.log('åŠ è½½æ•´æœ¬ä¹¦ï¼Œå¯ç”¨è¿ç»­æ»šåŠ¨');
                    epubRenderer.display().then(function() {
                        console.log('æ•´æœ¬ä¹¦æ˜¾ç¤ºæˆåŠŸ');
                        loading.style.display = 'none';
                        applySettings();
                    }).catch(function(error) {
                        console.error('æ•´æœ¬ä¹¦æ˜¾ç¤ºå¤±è´¥:', error);
                        loading.style.display = 'none';
                        // å°è¯•ç›´æ¥åŠ è½½ç« èŠ‚
                        contentContainer.innerHTML = '';
                        loadFirstChapterDirectly();
                    });
                    

                } catch (renderError) {
                    console.error('åˆ›å»ºæ ‡å‡†æ¸²æŸ“å™¨å¤±è´¥:', renderError);
                    loading.style.display = 'none';
                    // å°è¯•ç›´æ¥åŠ è½½ç« èŠ‚
                    contentContainer.innerHTML = '';
                    loadFirstChapterDirectly();
                }
                
            } catch (error) {
                console.error('æ ‡å‡†æ–¹æ³•åŠ è½½EPUBå†…å®¹å¤±è´¥:', error);
                loading.style.display = 'none';
                showError('EPUBå†…å®¹åŠ è½½å¤±è´¥: ' + error.message);
            }
        }
        
        // ç›´æ¥åŠ è½½ç¬¬ä¸€ä¸ªç« èŠ‚
        function loadFirstChapterDirectly() {
            const contentContainer = document.getElementById('content-container');
            const loading = document.getElementById('loading');
            
            try {
                console.log('å°è¯•ç›´æ¥åŠ è½½ç¬¬ä¸€ä¸ªç« èŠ‚');
                
                if (chapters.length > 0 && chapters[0].href) {
                    console.log('åŠ è½½ç¬¬ä¸€ä¸ªç« èŠ‚:', chapters[0].title, chapters[0].href);
                    
                    // éšè—åŠ è½½åŠ¨ç”»
                    loading.style.display = 'none';
                    contentContainer.style.display = 'block';
                    
                    // æ¸…ç©ºå®¹å™¨
                    contentContainer.innerHTML = '';
                    
                    // åˆ›å»ºç« èŠ‚å†…å®¹åŒºåŸŸ
                    const chapterContent = document.createElement('div');
                    chapterContent.style.padding = '20px';
                    chapterContent.style.lineHeight = '1.8';
                    chapterContent.style.fontFamily = 'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif';
                    
                    // æ˜¾ç¤ºåŠ è½½ä¸­ä¿¡æ¯
                    chapterContent.innerHTML = '<div style="text-align: center; padding: 40px;">æ­£åœ¨åŠ è½½ç« èŠ‚å†…å®¹...</div>';
                    contentContainer.appendChild(chapterContent);
                    
                    // å°è¯•è·å–ç« èŠ‚å†…å®¹
                    epubBook.load(chapters[0].href).then(function(documentObj) {
                        console.log('ç« èŠ‚å†…å®¹åŠ è½½æˆåŠŸï¼Œè¿”å›ç±»å‹:', typeof documentObj, 'æ„é€ å‡½æ•°:', documentObj.constructor.name);
                        
                        // æ­£ç¡®å¤„ç†è¿”å›çš„æ–‡æ¡£å¯¹è±¡
                        let contentHtml = '';
                        if (documentObj && (documentObj instanceof XMLDocument || documentObj instanceof HTMLDocument)) {
                            // æå–æ–‡æ¡£çš„bodyå†…å®¹
                            if (documentObj.body) {
                                // å…‹éš†bodyå…ƒç´ ä»¥é¿å…ä¿®æ”¹åŸå§‹æ–‡æ¡£
                                const bodyClone = documentObj.body.cloneNode(true);
                                
                                // ç§»é™¤æ‰€æœ‰å¯èƒ½å¯¼è‡´èµ„æºåŠ è½½çš„å…ƒç´ 
                                const elementsToRemove = bodyClone.querySelectorAll('img, link, script, iframe, embed, object');
                                elementsToRemove.forEach(el => el.remove());
                                
                                // ç§»é™¤æ‰€æœ‰å¯èƒ½çš„èµ„æºå¼•ç”¨å±æ€§
                                const elementsWithSrc = bodyClone.querySelectorAll('[src], [href], [data-src], [background], [srcset]');
                                elementsWithSrc.forEach(el => {
                                    el.removeAttribute('src');
                                    el.removeAttribute('href');
                                    el.removeAttribute('data-src');
                                    el.removeAttribute('background');
                                    el.removeAttribute('srcset');
                                });
                                
                                // æ¸…ç†å†…è”æ ·å¼ä¸­çš„èµ„æºå¼•ç”¨
                                const elementsWithStyle = bodyClone.querySelectorAll('[style]');
                                elementsWithStyle.forEach(el => {
                                    let style = el.getAttribute('style');
                                    if (style) {
                                        // ç§»é™¤åŒ…å« url() çš„æ ·å¼
                                        style = style.replace(/url\([^)]*\)/g, '');
                                        el.setAttribute('style', style);
                                    }
                                });
                                
                                // è·å–å¤„ç†åçš„HTML
                                contentHtml = bodyClone.innerHTML;
                            } else if (documentObj.documentElement) {
                                // å¯¹äºXMLæ–‡æ¡£ï¼Œå°è¯•è·å–æ‰€æœ‰å†…å®¹
                                contentHtml = documentObj.documentElement.outerHTML;
                            }
                        } else if (typeof documentObj === 'string') {
                            // å¦‚æœè¿”å›çš„æ˜¯å­—ç¬¦ä¸²ï¼Œç›´æ¥ä½¿ç”¨
                            contentHtml = documentObj;
                        } else {
                            // å…¶ä»–ç±»å‹ï¼Œå°è¯•è½¬æ¢ä¸ºå­—ç¬¦ä¸²
                            contentHtml = String(documentObj);
                        }
                        
                        // æ£€æŸ¥æå–çš„å†…å®¹
                        if (contentHtml.trim() === '') {
                            contentHtml = '<div style="text-align: center; padding: 40px; color: #999;">ç« èŠ‚å†…å®¹ä¸ºç©º</div>';
                        }
                        
                        console.log('æå–çš„ç« èŠ‚å†…å®¹é•¿åº¦:', contentHtml.length);
                        chapterContent.innerHTML = contentHtml;
                        applySettings();
                        
                        // æ¢å¤æ‰¹æ³¨å’Œé«˜äº®æ•ˆæœ
                        loadAnnotations();
                        highlightAnnotations();
                    }).catch(function(error) {
                        console.error('ç« èŠ‚å†…å®¹åŠ è½½å¤±è´¥:', error);
                        chapterContent.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">ç« èŠ‚å†…å®¹åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
                    });
                } else {
                    console.error('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„ç« èŠ‚');
                    loading.style.display = 'none';
                    contentContainer.style.display = 'block';
                    contentContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">æ²¡æœ‰æ‰¾åˆ°ç« èŠ‚å†…å®¹</div>';
                }
                
            } catch (error) {
                console.error('ç›´æ¥åŠ è½½ç« èŠ‚å¤±è´¥:', error);
                loading.style.display = 'none';
                contentContainer.style.display = 'block';
                contentContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
            }
        }
        
        // åŠ è½½ PDF æ–‡ä»¶
        function loadPDFFile() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            
            loading.style.display = 'flex';
            error.style.display = 'none';
            
            try {
                // æ£€æŸ¥æ˜¯å¦æœ‰ PDF æ–‡ä»¶æ•°æ®
                if (!currentBook.fileData) {
                    showError('æœªæ‰¾åˆ° PDF æ–‡ä»¶æ•°æ®ï¼Œè¯·è¿”å›é‡æ–°é€‰æ‹©ä¹¦ç±');
                    console.error('ç¼ºå°‘æ–‡ä»¶æ•°æ®:', currentBook);
                    return;
                }
                
                console.log('å¼€å§‹åŠ è½½PDFæ–‡ä»¶:', currentBook.title);
                
                // è®¾ç½® PDF.js worker
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
                
                // å¤„ç†æ–‡ä»¶æ•°æ®æ ¼å¼
                let pdfData = currentBook.fileData;
                if (currentBook.dataType === 'base64') {
                    console.log('å¤„ç† Base64 æ ¼å¼æ•°æ®');
                    try {
                        pdfData = base64ToArrayBuffer(currentBook.fileData);
                        console.log('Base64 è½¬ ArrayBuffer æˆåŠŸï¼Œè½¬æ¢åé•¿åº¦:', pdfData.byteLength);
                    } catch (base64Error) {
                        console.error('Base64 è½¬æ¢å¤±è´¥:', base64Error);
                        showError('PDF æ–‡ä»¶æ•°æ®æ ¼å¼é”™è¯¯: ' + base64Error.message);
                        return;
                    }
                }
                
                // åŠ è½½ PDF æ–‡æ¡£
                const loadingTask = pdfjsLib.getDocument(pdfData);
                loadingTask.promise.then(function(pdf) {
                    pdfDoc = pdf;
                    pdfPageNum = 1;
                    
                    console.log('PDF åŠ è½½æˆåŠŸï¼Œæ€»é¡µæ•°:', pdf.numPages);
                    
                    // ç”Ÿæˆç« èŠ‚åˆ—è¡¨ï¼ˆæ¯ä¸€é¡µä½œä¸ºä¸€ä¸ªç« èŠ‚ï¼‰
                    chapters = [];
                    for (let i = 1; i <= pdf.numPages; i++) {
                        chapters.push({
                            id: i,
                            title: `ç¬¬ ${i} é¡µ`,
                            href: i.toString()
                        });
                    }
                    
                    // æ¸²æŸ“ç« èŠ‚åˆ—è¡¨
                    renderChapterList();
                    
                    // åŠ è½½ç¬¬ä¸€é¡µ
                    loadPDFPage(1);
                }).catch(function(error) {
                    console.error('PDF åŠ è½½å¤±è´¥:', error);
                    showError('PDF æ–‡ä»¶åŠ è½½å¤±è´¥: ' + error.message);
                });
            } catch (error) {
                console.error('PDF åŠ è½½é”™è¯¯:', error);
                showError('PDF æ–‡ä»¶åŠ è½½å¤±è´¥: ' + error.message);
            }
        }
        
        // åŠ è½½ PDF é¡µé¢
        function loadPDFPage(pageNum) {
            if (!pdfDoc || pdfRendering) return;
            
            pdfRendering = true;
            const loading = document.getElementById('loading');
            const contentContainer = document.getElementById('content-container');
            
            loading.style.display = 'flex';
            contentContainer.style.display = 'none';
            
            pdfDoc.getPage(pageNum).then(function(page) {
                console.log('åŠ è½½ PDF é¡µé¢:', pageNum);
                
                const viewport = page.getViewport({ scale: pdfScale });
                
                // åˆ›å»º canvas
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                // æ¸²æŸ“é¡µé¢
                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                
                const renderTask = page.render(renderContext);
                
                renderTask.promise.then(function() {
                    // æ¸…ç©ºå®¹å™¨å¹¶æ˜¾ç¤ºé¡µé¢
                    contentContainer.innerHTML = '';
                    contentContainer.style.display = 'block';
                    loading.style.display = 'none';
                    
                    const pageContainer = document.createElement('div');
                    pageContainer.className = 'pdf-page';
                    pageContainer.style.position = 'relative';
                    
                    // æ·»åŠ  canvas
                    canvas.style.position = 'absolute';
                    canvas.style.top = '0';
                    canvas.style.left = '0';
                    pageContainer.appendChild(canvas);
                    
                    // åˆ›å»ºæ–‡æœ¬å±‚
                    const textLayerDiv = document.createElement('div');
                    textLayerDiv.className = 'textLayer';
                    textLayerDiv.style.position = 'absolute';
                    textLayerDiv.style.top = '0';
                    textLayerDiv.style.left = '0';
                    textLayerDiv.style.right = '0';
                    textLayerDiv.style.bottom = '0';
                    textLayerDiv.style.pointerEvents = 'auto';
                    textLayerDiv.style.opacity = '0';
                    pageContainer.appendChild(textLayerDiv);
                    
                    // è®¾ç½®æ–‡æœ¬å±‚å¤§å°
                    const textLayer = new pdfjsLib.renderTextLayer({
                        textContent: null,
                        container: textLayerDiv,
                        viewport: viewport.clone({}),
                        textDivs: [],
                        renderInteractiveForms: false
                    });
                    
                    // åŠ è½½æ–‡æœ¬å†…å®¹
                    page.getTextContent().then(function(textContent) {
                        textLayer.setTextContent(textContent);
                        textLayer.render();
                        
                        // ç¡®ä¿æ–‡æœ¬å±‚èƒ½å¤Ÿå“åº”é¼ æ ‡äº‹ä»¶
                        textLayerDiv.style.pointerEvents = 'auto';
                    });
                    
                    contentContainer.appendChild(pageContainer);
                    
                    // åº”ç”¨è®¾ç½®
                    applySettings();
                    
                    // æ›´æ–°å½“å‰ç« èŠ‚
                    currentChapter = pageNum - 1;
                    
                    pdfRendering = false;
                }).catch(function(error) {
                    console.error('PDF é¡µé¢æ¸²æŸ“å¤±è´¥:', error);
                    showError('PDF é¡µé¢æ¸²æŸ“å¤±è´¥: ' + error.message);
                    pdfRendering = false;
                });
            }).catch(function(error) {
                console.error('PDF é¡µé¢åŠ è½½å¤±è´¥:', error);
                showError('PDF é¡µé¢åŠ è½½å¤±è´¥: ' + error.message);
                pdfRendering = false;
            });
        }
        
        // æ¸²æŸ“ç« èŠ‚åˆ—è¡¨
        function renderChapterList() {
            const chapterList = document.getElementById('chapter-list');
            chapterList.innerHTML = '';
            
            chapters.forEach((chapter, index) => {
                const chapterItem = document.createElement('div');
                chapterItem.className = `chapter-item`;
                chapterItem.textContent = chapter.title;
                chapterItem.onclick = () => switchChapter(index);
                chapterList.appendChild(chapterItem);
            });
        }
        
        // åˆ‡æ¢ç« èŠ‚
        function switchChapter(index) {
            currentChapter = index;
            
            // æ ¹æ®ä¹¦ç±æ ¼å¼åˆ‡æ¢
            if (currentBook.format === 'pdf') {
                loadPDFPage(index + 1);
            } else {
                const chapter = chapters[index];
                if (!chapter || !chapter.href) {
                    console.error('ç« èŠ‚ä¿¡æ¯æ— æ•ˆ:', chapter);
                    return;
                }
                
                console.log('åˆ‡æ¢åˆ°ç« èŠ‚:', chapter.title, 'ç´¢å¼•:', index);
                
                // é‡æ–°åŠ è½½å†…å®¹
                reloadChapterContent(index);
                
                renderChapterList();
                closeSidebar();
            }
        }
        
        // é‡æ–°åŠ è½½ç« èŠ‚å†…å®¹
        function reloadChapterContent(index) {
            console.log('é‡æ–°åŠ è½½ç« èŠ‚å†…å®¹:', index);
            const loading = document.getElementById('loading');
            
            try {
                // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„ç« èŠ‚
                const chapter = chapters[index];
                if (!chapter || !chapter.href) {
                    console.error('ç« èŠ‚ä¿¡æ¯æ— æ•ˆ:', chapter);
                    showError('ç« èŠ‚ä¿¡æ¯æ— æ•ˆï¼Œæ— æ³•åŠ è½½å†…å®¹');
                    return;
                }
                
                console.log('åŠ è½½ç« èŠ‚:', chapter.title, 'href:', chapter.href);
                
                // ä¿å­˜å½“å‰ç« èŠ‚ç´¢å¼•
                currentChapter = index;
                
                // å¦‚æœæ¸²æŸ“å™¨å·²ç»å­˜åœ¨ï¼Œç›´æ¥ä½¿ç”¨å®ƒæ˜¾ç¤ºç« èŠ‚
                if (epubRenderer && typeof epubRenderer.display === 'function') {
                    console.log('ä½¿ç”¨ç°æœ‰æ¸²æŸ“å™¨æ˜¾ç¤ºç« èŠ‚');
                    loading.style.display = 'flex';
                    
                    epubRenderer.display(chapter.href).then(function() {
                        console.log('ç« èŠ‚æ˜¾ç¤ºæˆåŠŸ');
                        loading.style.display = 'none';
                        applySettings();
                        
                        // æ¢å¤æ‰¹æ³¨å’Œé«˜äº®æ•ˆæœ
                        loadAnnotations();
                        highlightAnnotations();
                    }).catch(function(error) {
                        console.error('ç« èŠ‚æ˜¾ç¤ºå¤±è´¥:', error);
                        loading.style.display = 'none';
                        // å°è¯•ç›´æ¥åŠ è½½ç« èŠ‚
                        loadFirstChapterDirectly();
                    });
                } else {
                    // å¦‚æœæ¸²æŸ“å™¨ä¸å­˜åœ¨ï¼Œé‡æ–°åŠ è½½å†…å®¹
                    console.log('æ¸²æŸ“å™¨ä¸å­˜åœ¨ï¼Œé‡æ–°åŠ è½½å†…å®¹');
                    loadEPUBContentStandard(null, index);
                }
                
            } catch (error) {
                console.error('é‡æ–°åŠ è½½ç« èŠ‚å†…å®¹é”™è¯¯:', error);
                showError('æ— æ³•åŠ è½½ç« èŠ‚å†…å®¹: ' + error.message);
            }
        }
        
        // ä¸Šä¸€é¡µ
        function prevPage() {
            if (currentChapter > 0) {
                switchChapter(currentChapter - 1);
            }
        }
        
        // ä¸‹ä¸€é¡µ
        function nextPage() {
            if (currentChapter < chapters.length - 1) {
                switchChapter(currentChapter + 1);
            }
        }
        
        // åŠ è½½ä¹¦ç±å†…å®¹
        function loadBookContent() {
            const loading = document.getElementById('loading');
            const contentContainer = document.getElementById('content-container');
            
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            loading.style.display = 'flex';
            contentContainer.style.display = 'none';
            contentContainer.innerHTML = ''; // æ¸…ç©ºå®¹å™¨å†…å®¹
            
            try {
                // æ£€æŸ¥æ˜¯å¦ä¸ºTXTæ–‡ä»¶
                if (currentBook.format === 'txt' && currentBook.fileData) {
                    // å¤„ç†TXTæ–‡ä»¶
                    let txtContent = currentBook.fileData;
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸ºBase64æ ¼å¼
                    if (currentBook.dataType === 'base64') {
                        console.log('æ£€æµ‹åˆ°Base64æ ¼å¼çš„TXTæ–‡ä»¶ï¼Œæ­£åœ¨è§£ç ...');
                        try {
                            // Base64è§£ç 
                            txtContent = atob(currentBook.fileData);
                            console.log('Base64è§£ç æˆåŠŸï¼Œå†…å®¹é•¿åº¦:', txtContent.length);
                        } catch (decodeError) {
                            console.error('Base64è§£ç å¤±è´¥:', decodeError);
                            showError('TXTæ–‡ä»¶è§£ç å¤±è´¥: ' + decodeError.message);
                            loading.style.display = 'none';
                            return;
                        }
                    }
                    
                    // æ˜¾ç¤ºTXTå†…å®¹
                    contentContainer.innerHTML = `<div style="white-space: pre-wrap; line-height: 1.8; padding: 20px;">${txtContent}</div>`;
                    chapters = [{ id: 0, title: currentBook.title, href: '' }];
                    renderChapterList();
                    
                    // åº”ç”¨è®¾ç½®
                    applySettings();
                    
                    // éšè—åŠ è½½åŠ¨ç”»ï¼Œæ˜¾ç¤ºå†…å®¹
                    loading.style.display = 'none';
                    contentContainer.style.display = 'block';
                    console.log('TXTæ–‡ä»¶åŠ è½½å®Œæˆ');
                    return;
                }
                
                // å¤„ç†EPUBæ–‡ä»¶
                if (epubBook && chapters.length > 0) {
                    console.log('å¼€å§‹åŠ è½½EPUBå†…å®¹');
                    
                    // ä¼˜åŒ–æ¸²æŸ“å‚æ•°ï¼Œç¡®ä¿ç« èŠ‚å†…å®¹æ”¯æŒæ»šåŠ¨
                    const renderOptions = {
                        width: '100%',
                        height: '100%',
                        manager: 'continuous', // ä½¿ç”¨è¿ç»­æ¨¡å¼
                        flow: 'scrolled-continuous', // è¿ç»­æ»šåŠ¨æµ
                        spread: 'none', // ä¸ä½¿ç”¨åŒé¡µæ¨¡å¼
                        styles: {
                            'body': {
                                'margin': '0',
                                'padding': '20px',
                                'font-family': 'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'
                            }
                        }
                    };
                    
                    console.log('å¼€å§‹æ¸²æŸ“EPUBå†…å®¹ï¼Œä½¿ç”¨æ»šåŠ¨æ¨¡å¼');
                    
                    try {
                        console.log('è°ƒç”¨ epubBook.renderTo æ¸²æŸ“å†…å®¹');
                        
                        // æ¸…ç©ºå®¹å™¨
                        contentContainer.innerHTML = '';
                        
                        // ç¡®ä¿å®¹å™¨æœ‰æ­£ç¡®çš„å°ºå¯¸
                        contentContainer.style.width = '100%';
                        contentContainer.style.height = '100%';
                        contentContainer.style.minHeight = '600px';
                        contentContainer.style.position = 'relative';
                        contentContainer.style.overflow = 'auto';
                        
                        // æ¸²æŸ“ç« èŠ‚
                        epubRenderer = epubBook.renderTo(contentContainer, renderOptions);
                        console.log('renderTo è°ƒç”¨å®Œæˆï¼Œæ¸²æŸ“å™¨:', epubRenderer);
                        
                        // ç­‰å¾…æ¸²æŸ“å®Œæˆ
                        epubRenderer.on('rendered', function() {
                            console.log('EPUBå†…å®¹æ¸²æŸ“å®Œæˆäº‹ä»¶è§¦å‘');
                            completeChapterLoad();
                        });
                        
                        // å¤„ç†é”™è¯¯
                        epubRenderer.on('error', function(error) {
                            console.error('æ¸²æŸ“å™¨é”™è¯¯:', error);
                            showError('EPUBå†…å®¹æ¸²æŸ“å¤±è´¥: ' + error.message);
                        });
                        

                        
                        // æ·»åŠ è¶…æ—¶å¤„ç†ï¼Œç¡®ä¿å³ä½¿äº‹ä»¶ä¸è§¦å‘ä¹Ÿèƒ½å®ŒæˆåŠ è½½
                        setTimeout(() => {
                            if (loading.style.display !== 'none') {
                                console.log('EPUBå†…å®¹æ¸²æŸ“äº‹ä»¶æœªè§¦å‘ï¼Œæ‰‹åŠ¨å®ŒæˆåŠ è½½');
                                completeChapterLoad();
                            }
                        }, 3000);
                        
                    } catch (renderError) {
                        console.error('æ¸²æŸ“å¤±è´¥:', renderError);
                        showError('EPUBå†…å®¹æ¸²æŸ“å¤±è´¥: ' + renderError.message);
                    }
                } else {
                    console.error('æ— æ³•åŠ è½½EPUBå†…å®¹çš„åŸå› :', {
                        epubBook: !!epubBook,
                        chaptersLength: chapters.length
                    });
                    showError('æ— æ³•åŠ è½½EPUBå†…å®¹');
                }
            } catch (error) {
                console.error('åŠ è½½ä¹¦ç±å†…å®¹é”™è¯¯:', error);
                showError('æ— æ³•åŠ è½½ä¹¦ç±å†…å®¹');
            }
        }
        
        // å®Œæˆç« èŠ‚åŠ è½½
        function completeChapterLoad() {
            const loading = document.getElementById('loading');
            const contentContainer = document.getElementById('content-container');
            
            // åº”ç”¨å½“å‰è®¾ç½®
            applySettings();
            
            // éšè—åŠ è½½åŠ¨ç”»ï¼Œæ˜¾ç¤ºå†…å®¹
            loading.style.display = 'none';
            contentContainer.style.display = 'block';
            console.log('ç« èŠ‚åŠ è½½å®Œæˆï¼Œå†…å®¹æ˜¾ç¤ºæˆåŠŸ');
            
            // æ¢å¤æ‰¹æ³¨å’Œé«˜äº®æ•ˆæœ
            loadAnnotations();
            highlightAnnotations();
            
            // ç¡®ä¿å®¹å™¨æœ‰å†…å®¹
            setTimeout(() => {
                if (contentContainer.innerHTML.trim() === '' || contentContainer.children.length === 0) {
                    console.error('å†…å®¹å®¹å™¨ä¸ºç©ºï¼Œé‡æ–°åŠ è½½å†…å®¹');
                    loadBookContent();
                }
            }, 1000);
        }
        
        // åŠ è½½æ•´æœ¬ä¹¦
        function loadEntireBook() {
            const loading = document.getElementById('loading');
            const contentContainer = document.getElementById('content-container');
            
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            loading.style.display = 'flex';
            contentContainer.style.display = 'none';
            contentContainer.innerHTML = ''; // æ¸…ç©ºå®¹å™¨å†…å®¹
            
            try {
                // æ£€æŸ¥ epubBook æ˜¯å¦æœ‰ renderTo æ–¹æ³•
                if (!epubBook || !epubBook.renderTo) {
                    console.error('epubBook ç¼ºå°‘ renderTo æ–¹æ³•:', epubBook);
                    showError('EPUB é˜…è¯»å™¨åˆå§‹åŒ–å¤±è´¥ï¼Œæ— æ³•æ¸²æŸ“å†…å®¹');
                    return;
                }
                
                // ç¡®ä¿å®¹å™¨æœ‰æ­£ç¡®çš„å°ºå¯¸
                contentContainer.innerHTML = '';
                contentContainer.style.width = '100%';
                contentContainer.style.height = '100%';
                contentContainer.style.minHeight = '400px';
                
                // ä¼˜åŒ–æ¸²æŸ“å‚æ•°ï¼Œç¡®ä¿æ•´æœ¬ä¹¦ä¸€æ¬¡æ€§åŠ è½½å¹¶æ”¯æŒæ»šåŠ¨
                const renderOptions = {
                    width: '100%',
                    height: '100%',
                    manager: 'continuous', // ä½¿ç”¨è¿ç»­æ¨¡å¼
                    flow: 'scrolled-continuous', // è¿ç»­æ»šåŠ¨æµ
                    spread: 'none', // ä¸ä½¿ç”¨åŒé¡µæ¨¡å¼
                    styles: {
                        'body': {
                            'margin': '0',
                            'padding': '0',
                            'font-family': 'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'
                        }
                    }
                };
                
                console.log('å¼€å§‹æ¸²æŸ“æ•´æœ¬ä¹¦ï¼Œä½¿ç”¨æ»šåŠ¨æ¨¡å¼');
                
                // æ¸²æŸ“æ•´æœ¬ä¹¦
                try {
                    console.log('è°ƒç”¨ epubBook.renderTo æ¸²æŸ“æ•´æœ¬ä¹¦');
                    epubRenderer = epubBook.renderTo(contentContainer, renderOptions);
                    console.log('renderTo è°ƒç”¨å®Œæˆï¼Œæ¸²æŸ“å™¨:', epubRenderer);
                    
                    // ç­‰å¾…æ¸²æŸ“å®Œæˆ
                    epubRenderer.on('rendered', function() {
                        console.log('æ•´æœ¬ä¹¦æ¸²æŸ“å®Œæˆäº‹ä»¶è§¦å‘');
                        completeChapterLoad();
                    });
                    
                    // å¤„ç†é”™è¯¯
                    epubRenderer.on('error', function(error) {
                        console.error('æ¸²æŸ“å™¨é”™è¯¯:', error);
                        showError('æ•´æœ¬ä¹¦æ¸²æŸ“å¤±è´¥: ' + error.message);
                    });
                    
                    // æ·»åŠ è¶…æ—¶å¤„ç†ï¼Œç¡®ä¿å³ä½¿äº‹ä»¶ä¸è§¦å‘ä¹Ÿèƒ½å®ŒæˆåŠ è½½
                    setTimeout(() => {
                        if (loading.style.display !== 'none') {
                            console.log('æ•´æœ¬ä¹¦æ¸²æŸ“äº‹ä»¶æœªè§¦å‘ï¼Œæ‰‹åŠ¨å®ŒæˆåŠ è½½');
                            completeChapterLoad();
                        }
                    }, 3000);
                    
                } catch (renderError) {
                    console.error('renderTo è°ƒç”¨å¤±è´¥:', renderError);
                    showError('æ¸²æŸ“å™¨åˆ›å»ºå¤±è´¥: ' + renderError.message);
                }
            } catch (error) {
                console.error('åŠ è½½æ•´æœ¬ä¹¦é”™è¯¯:', error);
                showError('æ— æ³•åŠ è½½æ•´æœ¬ä¹¦å†…å®¹');
            }
        }
        

        
        // åº”ç”¨è®¾ç½®
        function applySettings() {
            const contentContainer = document.getElementById('content-container');
            const readingArea = document.getElementById('reading-area');
            const notesSidebar = document.getElementById('notes-sidebar');
            const selectionMenu = document.getElementById('selection-menu');
            const notePopup = document.getElementById('note-popup');
            
            // æ£€æŸ¥å¿…è¦çš„å…ƒç´ æ˜¯å¦å­˜åœ¨
            if (!contentContainer || !readingArea) {
                console.error('ç¼ºå°‘å¿…è¦çš„DOMå…ƒç´ ');
                return;
            }
            
            // åº”ç”¨ä¸»é¢˜
            document.body.className = currentTheme;
            
            if (currentTheme === 'light') {
                readingArea.style.backgroundColor = '#f8f9ff';
                contentContainer.style.backgroundColor = 'white';
                contentContainer.style.color = '#333';
                if (notesSidebar) {
                    notesSidebar.style.backgroundColor = 'white';
                    notesSidebar.style.borderRightColor = '#f0f0f0';
                }
                if (selectionMenu) {
                    // é‡ç½®èœå•å®¹å™¨çš„æ ·å¼ï¼Œä½¿ç”¨æœ‰åˆ›æ„çš„å¡ç‰‡å¼è®¾è®¡
                    selectionMenu.style.backgroundColor = 'white';
                    selectionMenu.style.boxShadow = '0 16px 64px rgba(64, 158, 255, 0.3)';
                    selectionMenu.style.borderRadius = '20px';
                    selectionMenu.style.overflow = 'hidden';
                    selectionMenu.style.minWidth = '180px'; // ç¨å¾®æ”¹å¤§ä¸€ç‚¹
                    selectionMenu.style.padding = '12px 0'; // å¢åŠ å†…è¾¹è·
                    selectionMenu.style.position = 'relative';
                    selectionMenu.style.border = 'none';
                    
                    // æ·»åŠ åˆ›æ„èƒŒæ™¯æ•ˆæœï¼Œä½¿ç”¨åŠ¨æ€æ¸å˜
                    selectionMenu.style.background = 'linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%)';
                    selectionMenu.style.animation = 'menuGradient 3s ease-in-out infinite alternate';
                    
                    // æ·»åŠ æ¸å˜å‘å…‰æ•ˆæœ
                    if (!selectionMenu.querySelector('.glow-effect')) {
                        const glowEffect = document.createElement('div');
                        glowEffect.className = 'glow-effect';
                        glowEffect.style.position = 'absolute';
                        glowEffect.style.top = '-50%';
                        glowEffect.style.left = '-50%';
                        glowEffect.style.width = '200%';
                        glowEffect.style.height = '200%';
                        glowEffect.style.background = 'radial-gradient(circle, rgba(64, 158, 255, 0.1) 0%, rgba(255, 128, 171, 0.1) 50%, transparent 100%)';
                        glowEffect.style.animation = 'glowPulse 2s ease-in-out infinite';
                        glowEffect.style.zIndex = '0';
                        selectionMenu.appendChild(glowEffect);
                    }
                    
                    // è®¾ç½®èœå•é¡¹çš„æ ·å¼ï¼Œä½¿ç”¨æœ‰åˆ›æ„çš„è®¾è®¡
                    const menuItems = selectionMenu.querySelectorAll('.menu-item');
                    menuItems.forEach(item => {
                        item.style.color = '#333';
                        item.style.transition = 'all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                        item.style.position = 'relative';
                        item.style.zIndex = '2';
                        item.style.fontSize = '16px'; // ç¨å¾®å¢å¤§å­—ä½“
                        item.style.padding = '16px 24px'; // å¢åŠ å†…è¾¹è·ï¼Œä½¿èœå•é¡¹æ›´å¤§
                        item.style.cursor = 'pointer';
                        item.style.borderRadius = '16px'; // å¢åŠ åœ†è§’
                        item.style.margin = '4px 12px'; // å¢åŠ å¤–è¾¹è·
                        item.style.fontWeight = '500'; // å¢åŠ å­—ä½“æƒé‡
                        item.style.textAlign = 'center'; // æ–‡æœ¬å±…ä¸­
                        item.style.background = 'rgba(255, 255, 255, 0.8)'; // åŠé€æ˜ç™½è‰²èƒŒæ™¯
                        item.style.backdropFilter = 'blur(10px)'; // èƒŒæ™¯æ¨¡ç³Šæ•ˆæœ
                        item.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.05)'; // è½»å¾®é˜´å½±
                        
                        // ä¼˜åŒ–é¼ æ ‡æ‚¬åœæ•ˆæœï¼Œä½¿å®ƒæ›´æœ‰è¶£
                        item.onmouseover = function() {
                            this.style.background = 'linear-gradient(135deg, #409eff 0%, #ff80ab 100%)';
                            this.style.color = 'white';
                            this.style.transform = 'translateY(-4px) scale(1.05)'; // ä¸Šæµ®å¹¶ç¨å¾®æ”¾å¤§
                            this.style.boxShadow = '0 8px 32px rgba(64, 158, 255, 0.4)'; // å¢å¼ºé˜´å½±æ•ˆæœ
                            this.style.borderRadius = '20px'; // å¢å¤§åœ†è§’
                        };
                        item.onmouseout = function() {
                            this.style.background = 'rgba(255, 255, 255, 0.8)';
                            this.style.color = '#333';
                            this.style.transform = 'translateY(0) scale(1)'; // æ¢å¤åŸå§‹ä½ç½®å’Œå¤§å°
                            this.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.05)'; // æ¢å¤è½»å¾®é˜´å½±
                            this.style.borderRadius = '16px'; // æ¢å¤åŸå§‹åœ†è§’
                        };
                    });
                    
                    // æ·»åŠ å¿…è¦çš„åŠ¨ç”»æ ·å¼
                    if (!document.getElementById('menu-animations')) {
                        const styleSheet = document.createElement('style');
                        styleSheet.id = 'menu-animations';
                        styleSheet.textContent = `
                            @keyframes menuGradient {
                                0% { background-position: 0% 50%; }
                                100% { background-position: 100% 50%; }
                            }
                            @keyframes glowPulse {
                                0% { transform: scale(1); opacity: 0.5; }
                                50% { transform: scale(1.1); opacity: 0.8; }
                                100% { transform: scale(1); opacity: 0.5; }
                            }
                        `;
                        document.head.appendChild(styleSheet);
                    }
                }
                if (notePopup) {
                    notePopup.style.backgroundColor = 'white';
                    notePopup.style.boxShadow = '0 4px 16px rgba(0, 0, 0, 0.1)';
                    // è®¾ç½®æ‰¹æ³¨å¼¹çª—çš„ä¿å­˜æŒ‰é’®æ ·å¼ï¼Œä½¿ç”¨ä¸ index.html ç›¸åŒçš„æ¸å˜è‰²ä¸»é¢˜
                    const saveBtn = notePopup.querySelector('#save-note');
                    if (saveBtn) {
                        saveBtn.style.background = 'linear-gradient(135deg, #409eff 0%, #ff80ab 100%)';
                    }
                }
                if (epubRenderer) {
                    // å°è¯•è®¾ç½®ä¸»é¢˜
                    if (epubRenderer.theme && typeof epubRenderer.theme === 'function') {
                        epubRenderer.theme('light');
                        console.log('ä½¿ç”¨ theme æ–¹æ³•è®¾ç½®ä¸»é¢˜ä¸º light');
                    }
                }
            } else if (currentTheme === 'sepia') {
                readingArea.style.backgroundColor = '#f0e6d2';
                contentContainer.style.backgroundColor = '#f5f0e6';
                contentContainer.style.color = '#5c4b37';
                if (notesSidebar) {
                    notesSidebar.style.backgroundColor = '#f5f0e6';
                    notesSidebar.style.borderRightColor = '#e8e0d0';
                }
                if (selectionMenu) {
                    selectionMenu.style.backgroundColor = '#f5f0e6';
                    selectionMenu.style.boxShadow = '0 4px 16px rgba(92, 75, 55, 0.15)';
                    // è®¾ç½®èœå•é¡¹çš„æ ·å¼
                    const menuItems = selectionMenu.querySelectorAll('.menu-item');
                    menuItems.forEach(item => {
                        item.style.color = '#5c4b37';
                        item.onmouseover = function() {
                            this.style.backgroundColor = '#f0e6d2';
                        };
                        item.onmouseout = function() {
                            this.style.backgroundColor = '#f5f0e6';
                        };
                    });
                }
                if (notePopup) {
                    notePopup.style.backgroundColor = '#f5f0e6';
                    notePopup.style.boxShadow = '0 4px 16px rgba(92, 75, 55, 0.15)';
                }
                if (epubRenderer) {
                    // å°è¯•è®¾ç½®ä¸»é¢˜
                    if (epubRenderer.theme && typeof epubRenderer.theme === 'function') {
                        epubRenderer.theme('sepia');
                        console.log('ä½¿ç”¨ theme æ–¹æ³•è®¾ç½®ä¸»é¢˜ä¸º sepia');
                    }
                }
            }

            console.log('è®¾ç½®åº”ç”¨å®Œæˆ');
        }
        
        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const errorMessage = document.getElementById('error-message');
            
            loading.style.display = 'none';
            error.style.display = 'flex';
            errorMessage.textContent = message;
        }
        
        // æ‰“å¼€ä¾§è¾¹æ 
        function openSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            sidebar.classList.add('open');
            overlay.classList.add('show');
        }
        
        // å…³é—­ä¾§è¾¹æ 
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
        }
        
        // æ‰“å¼€è®¾ç½®é¢æ¿
        function openSettings() {
            const settingsPanel = document.getElementById('settings-panel');
            settingsPanel.classList.add('open');
        }
        
        // å…³é—­è®¾ç½®é¢æ¿
        function closeSettings() {
            const settingsPanel = document.getElementById('settings-panel');
            settingsPanel.classList.remove('open');
        }
        
        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // è¿”å›æŒ‰é’®
            document.getElementById('back-btn').addEventListener('click', () => {
                window.location.href = 'index.html';
            });

            // å…³é—­ä¾§è¾¹æ 
        document.getElementById('close-sidebar').addEventListener('click', closeSidebar);
        document.getElementById('overlay').addEventListener('click', () => {
            closeSidebar();
            closeNotesSidebar();
        });
            
            // è®¾ç½®æŒ‰é’®
            document.getElementById('settings-btn').addEventListener('click', openSettings);
            
            // å…³é—­è®¾ç½®
            document.getElementById('close-settings').addEventListener('click', closeSettings);
            
            // ä¸»é¢˜åˆ‡æ¢
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    currentTheme = option.dataset.theme;
                    applySettings();
                });
            });
            
            // é‡è¯•æŒ‰é’®
            document.getElementById('retry-btn').addEventListener('click', loadCurrentBook);
            
            // ç›®å½•æŒ‰é’®
            document.getElementById('toc-btn').addEventListener('click', openSidebar);
            
            // ç¿»è¯‘æŒ‰é’®
            document.getElementById('translate-btn').addEventListener('click', () => {
                window.location.href = 'translate.html';
            });
            
            // æ‰¹æ³¨æŒ‰é’®
            document.getElementById('notes-btn').addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('ç‚¹å‡»äº†æ‰¹æ³¨æŒ‰é’®');
                
                // ç›´æ¥æ˜¾ç¤ºæ‰¹æ³¨ä¾§è¾¹æ ï¼Œä¸è°ƒç”¨å‡½æ•°
                const sidebar = document.getElementById('notes-sidebar');
                const overlay = document.getElementById('overlay');
                if (sidebar && overlay) {
                    console.log('æ‰¾åˆ°æ‰¹æ³¨ä¾§è¾¹æ å’Œé®ç½©å±‚å…ƒç´ ');
                    // æ˜¾ç¤ºä¾§è¾¹æ 
                    sidebar.style.transform = 'translateX(0)';
                    // æ˜¾ç¤ºé®ç½©å±‚
                    overlay.style.display = 'block';
                    // æ¸²æŸ“æ‰¹æ³¨åˆ—è¡¨
                    const notesList = document.getElementById('notes-list');
                    if (notesList) {
                        notesList.innerHTML = '<div style="padding: 24px; text-align: center; color: #999;">æš‚æ— æ‰¹æ³¨</div>';
                    }
                } else {
                    console.error('æœªæ‰¾åˆ°å¿…è¦çš„å…ƒç´ ');
                }
            });
            
            // å…³é—­æ‰¹æ³¨ä¾§è¾¹æ 
            document.getElementById('close-notes-sidebar').addEventListener('click', closeNotesSidebar);
            
            // é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶ï¼Œæ ‡è®°å¼€å§‹é€‰æ‹©æ–‡æœ¬
            document.addEventListener('mousedown', function(e) {
                isSelectingText = true;
                console.log('é¼ æ ‡æŒ‰ä¸‹ï¼Œå¼€å§‹é€‰æ‹©æ–‡æœ¬');
            });
            
            // æ–‡æœ¬é€‰æ‹©äº‹ä»¶ - åªåœ¨é¼ æ ‡é‡Šæ”¾æ—¶æ£€æŸ¥ï¼Œç¡®ä¿èœå•åªåœ¨ç”¨æˆ·æ¾å¼€é¼ æ ‡ä¸”é€‰æ‹©äº†æ–‡æœ¬çš„æƒ…å†µä¸‹æ˜¾ç¤º
            document.addEventListener('mouseup', function(e) {
                if (isSelectingText) {
                    console.log('é¼ æ ‡é‡Šæ”¾ï¼Œæ£€æŸ¥æ–‡æœ¬é€‰æ‹©');
                    // å»¶è¿Ÿä¸€ä¸‹ï¼Œç¡®ä¿é€‰æ‹©å·²ç»å®Œæˆ
                    setTimeout(function() {
                        handleTextSelection();
                        // å»¶è¿Ÿæ›´é•¿æ—¶é—´é‡ç½®isSelectingTextï¼Œç¡®ä¿ç‚¹å‡»äº‹ä»¶å¤„ç†å®Œæˆ
                        setTimeout(function() {
                            isSelectingText = false;
                        }, 200);
                    }, 50);
                }
            });
            
            // ç§»é™¤ selectionchange äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…åœ¨é€‰æ‹©è¿‡ç¨‹ä¸­å¤šæ¬¡è§¦å‘
            // document.addEventListener('selectionchange', function(e) {
            //     console.log('æ–‡æœ¬é€‰æ‹©å˜åŒ–');
            //     handleTextSelection();
            // });
            
            // æ‰¹æ³¨å¼¹çª—äº‹ä»¶
            document.getElementById('save-note').addEventListener('click', saveNote);
            document.getElementById('cancel-note').addEventListener('click', closeNotePopup);
            document.getElementById('cancel-note-btn').addEventListener('click', closeNotePopup);
            
            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
            document.getElementById('note-popup').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeNotePopup();
                }
            });
            
            // ç»‘å®šè§å…‰ç¬”é¢œè‰²é€‰æ‹©äº‹ä»¶
            bindColorSelectionEvents();
            
            // æ–‡æœ¬é€‰æ‹©èœå•äº‹ä»¶
            document.getElementById('menu-copy').addEventListener('click', function() {
                hideSelectionMenu();
                // å¤åˆ¶é€‰ä¸­çš„æ–‡æœ¬
                let selectedText = '';
                
                // é¦–å…ˆæ£€æŸ¥ä¸»çª—å£çš„é€‰æ‹©
                const mainSelection = window.getSelection();
                if (mainSelection && mainSelection.toString().trim()) {
                    selectedText = mainSelection.toString().trim();
                    console.log('ä»ä¸»çª—å£è·å–é€‰ä¸­çš„æ–‡æœ¬:', selectedText);
                } else {
                    // å¦‚æœä¸»çª—å£æ²¡æœ‰é€‰æ‹©ï¼Œæ£€æŸ¥æ‰€æœ‰ iframe
                    const iframes = document.querySelectorAll('iframe');
                    for (let i = 0; i < iframes.length; i++) {
                        try {
                            const iframe = iframes[i];
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                            if (iframeDoc) {
                                const iframeSelection = iframeDoc.getSelection();
                                if (iframeSelection && iframeSelection.toString().trim()) {
                                    selectedText = iframeSelection.toString().trim();
                                    console.log('ä»iframeè·å–é€‰ä¸­çš„æ–‡æœ¬:', selectedText);
                                    break;
                                }
                            }
                        } catch (error) {
                            console.error('æ£€æŸ¥iframeé€‰æ‹©å¤±è´¥:', error);
                        }
                    }
                }
                
                // å°è¯•å¤åˆ¶é€‰ä¸­çš„æ–‡æœ¬
                if (selectedText) {
                    console.log('å‡†å¤‡å¤åˆ¶çš„æ–‡æœ¬:', selectedText);
                    
                    // ç›´æ¥ä½¿ç”¨ä¸´æ—¶ textarea æ–¹æ³•ï¼Œè¿™æ˜¯æœ€å¯é çš„æ–¹æ³•
                    const textarea = document.createElement('textarea');
                    textarea.value = selectedText;
                    textarea.style.position = 'fixed';
                    textarea.style.left = '-999999px';
                    textarea.style.top = '-999999px';
                    textarea.style.width = '2em';
                    textarea.style.height = '2em';
                    textarea.style.padding = '0';
                    textarea.style.border = 'none';
                    textarea.style.outline = 'none';
                    textarea.style.boxShadow = 'none';
                    textarea.style.background = 'transparent';
                    
                    document.body.appendChild(textarea);
                    
                    // ç¡®ä¿ textarea è·å¾—ç„¦ç‚¹å¹¶è¢«é€‰ä¸­
                    textarea.focus();
                    textarea.select();
                    
                    try {
                        console.log('æ‰§è¡Œå¤åˆ¶å‘½ä»¤');
                        const successful = document.execCommand('copy');
                        const msg = successful ? 'å¤åˆ¶æˆåŠŸ' : 'å¤åˆ¶å¤±è´¥';
                        console.log('å¤åˆ¶ç»“æœ:', msg);
                        
                        // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçš„æç¤º
                        showCopySuccess();
                    } catch (error) {
                        console.error('å¤åˆ¶å¤±è´¥:', error);
                        
                        // å°è¯•ä½¿ç”¨ Clipboard API ä½œä¸ºå¤‡ç”¨
                        if (navigator.clipboard && window.isSecureContext) {
                            console.log('å°è¯•ä½¿ç”¨ Clipboard API');
                            navigator.clipboard.writeText(selectedText).then(function() {
                                console.log('å¤åˆ¶æˆåŠŸï¼ˆä½¿ç”¨ Clipboard APIï¼‰');
                                showCopySuccess();
                            }).catch(function(error) {
                                console.error('Clipboard API å¤åˆ¶å¤±è´¥:', error);
                            });
                        }
                    } finally {
                        // æ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œéƒ½ç§»é™¤ä¸´æ—¶ textarea
                        document.body.removeChild(textarea);
                    }
                } else {
                    console.error('æ²¡æœ‰é€‰ä¸­çš„æ–‡æœ¬å¯ä»¥å¤åˆ¶');
                }
            });
            
            // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçš„æç¤º
            function showCopySuccess() {
                const notification = document.createElement('div');
                notification.style.position = 'fixed';
                notification.style.top = '20px';
                notification.style.right = '20px';
                notification.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
                notification.style.color = 'white';
                notification.style.padding = '10px 16px';
                notification.style.borderRadius = '8px';
                notification.style.fontSize = '14px';
                notification.style.zIndex = '9999';
                notification.style.transition = 'opacity 0.3s ease';
                notification.textContent = 'å¤åˆ¶æˆåŠŸ';
                
                document.body.appendChild(notification);
                
                // 3ç§’åæ·¡å‡ºå¹¶ç§»é™¤æç¤º
                setTimeout(function() {
                    notification.style.opacity = '0';
                    setTimeout(function() {
                        document.body.removeChild(notification);
                    }, 300);
                }, 2000);
            }
            
            document.getElementById('menu-add-note').addEventListener('click', function() {
                hideSelectionMenu();
                openNotePopup();
            });
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹éšè—é€‰æ‹©èœå•
            document.addEventListener('click', function(e) {
                const menu = document.getElementById('selection-menu');
                if (!isSelectingText && menu && menu.style.display === 'block' && !menu.contains(e.target)) {
                    // å»¶è¿Ÿä¸€ä¸‹ï¼Œç¡®ä¿èœå•ç‚¹å‡»äº‹ä»¶è¢«å¤„ç†
                    setTimeout(function() {
                        hideSelectionMenu();
                    }, 100);
                }
            });

            // ç§»é™¤é”®ç›˜ç¿»é¡µåŠŸèƒ½
            // æ³¨æ„ï¼šä¿ç•™æ­¤æ³¨é‡Šä»¥è¯´æ˜å·²ç§»é™¤é”®ç›˜ç¿»é¡µåŠŸèƒ½
        }
        
        // å¤„ç†æ–‡æœ¬é€‰æ‹©
        function handleTextSelection() {
            console.log('å¤„ç†æ–‡æœ¬é€‰æ‹©');
            
            // é¦–å…ˆæ£€æŸ¥ä¸»çª—å£çš„é€‰æ‹©
            let selection = window.getSelection();
            let selectedText = selection ? selection.toString().trim() : '';
            let selectionRange = null;
            
            console.log('ä¸»çª—å£é€‰æ‹©å¯¹è±¡:', selection);
            console.log('ä¸»çª—å£é€‰ä¸­çš„æ–‡æœ¬:', selectedText);
            
            // å¦‚æœä¸»çª—å£æ²¡æœ‰é€‰æ‹©ï¼Œæ£€æŸ¥æ‰€æœ‰ iframe
            if (!selectedText) {
                console.log('ä¸»çª—å£æ²¡æœ‰é€‰æ‹©ï¼Œæ£€æŸ¥ iframe');
                const iframes = document.querySelectorAll('iframe');
                for (let i = 0; i < iframes.length; i++) {
                    try {
                        const iframe = iframes[i];
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        if (iframeDoc) {
                            const iframeSelection = iframeDoc.getSelection();
                            if (iframeSelection) {
                                const iframeSelectedText = iframeSelection.toString().trim();
                                console.log('iframeé€‰æ‹©å¯¹è±¡:', iframeSelection);
                                console.log('iframeé€‰ä¸­çš„æ–‡æœ¬:', iframeSelectedText);
                                if (iframeSelectedText) {
                                    selectedText = iframeSelectedText;
                                    selection = iframeSelection;
                                    if (iframeSelection.rangeCount > 0) {
                                        selectionRange = iframeSelection.getRangeAt(0);
                                    }
                                    break;
                                }
                            }
                        }
                    } catch (error) {
                        console.error('æ£€æŸ¥iframeé€‰æ‹©å¤±è´¥:', error);
                    }
                }
            } else {
                // ä¸»çª—å£æœ‰é€‰æ‹©ï¼Œè·å–é€‰æ‹©èŒƒå›´
                if (selection.rangeCount > 0) {
                    selectionRange = selection.getRangeAt(0);
                }
            }
            
            // æ›´æ–°å…¨å±€å˜é‡
            window.selectedText = selectedText;
            window.selectionRange = selectionRange;
            
            // æ˜¾ç¤ºæˆ–éšè—èœå•
            if (selectedText) {
                console.log('æœ‰é€‰ä¸­çš„æ–‡æœ¬ï¼Œæ˜¾ç¤ºèœå•');
                showSelectionMenu();
            } else {
                console.log('æ²¡æœ‰é€‰ä¸­çš„æ–‡æœ¬ï¼Œéšè—èœå•');
                hideSelectionMenu();
            }
        }
        
        // æ˜¾ç¤ºæ–‡æœ¬é€‰æ‹©èœå•
        function showSelectionMenu() {
            console.log('æ˜¾ç¤ºæ–‡æœ¬é€‰æ‹©èœå•');
            const menu = document.getElementById('selection-menu');
            console.log('èœå•å…ƒç´ :', menu);
            
            if (menu) {
                let rect = null;
                
                // é¦–å…ˆæ£€æŸ¥æ‰€æœ‰ iframeï¼ˆä¼˜å…ˆä½¿ç”¨ iframe ä¸­çš„é€‰æ‹©èŒƒå›´ï¼‰
                console.log('é¦–å…ˆæ£€æŸ¥ iframe ä¸­çš„é€‰æ‹©èŒƒå›´');
                const iframes = document.querySelectorAll('iframe');
                for (let i = 0; i < iframes.length; i++) {
                    try {
                        const iframe = iframes[i];
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        if (iframeDoc) {
                            const iframeSelection = iframeDoc.getSelection();
                            if (iframeSelection && iframeSelection.rangeCount > 0) {
                                try {
                                    const iframeRange = iframeSelection.getRangeAt(0);
                                    const iframeRect = iframeRange.getBoundingClientRect();
                                    console.log('iframeé€‰ä¸­åŒºåŸŸçš„ä½ç½®:', iframeRect);
                                    
                                    // è·å– iframe åœ¨é¡µé¢ä¸­çš„ä½ç½®
                                    const iframeOffset = iframe.getBoundingClientRect();
                                    console.log('iframeåœ¨é¡µé¢ä¸­çš„ä½ç½®:', iframeOffset);
                                    
                                    // è½¬æ¢åæ ‡ä¸ºé¡µé¢åæ ‡
                                    rect = {
                                        left: iframeRect.left + iframeOffset.left,
                                        top: iframeRect.top + iframeOffset.top,
                                        width: iframeRect.width,
                                        height: iframeRect.height,
                                        bottom: iframeRect.top + iframeOffset.top + iframeRect.height
                                    };
                                    console.log('è½¬æ¢åçš„é¡µé¢åæ ‡:', rect);
                                    break;
                                } catch (error) {
                                    console.error('è·å– iframe é€‰æ‹©èŒƒå›´å¤±è´¥:', error);
                                }
                            }
                        }
                    } catch (error) {
                        console.error('æ£€æŸ¥iframeé€‰æ‹©å¤±è´¥:', error);
                    }
                }
                
                // å¦‚æœ iframe ä¸­æ²¡æœ‰é€‰æ‹©ï¼Œå°è¯•æ£€æŸ¥ä¸»çª—å£çš„é€‰æ‹©
                if (!rect) {
                    const mainSelection = window.getSelection();
                    if (mainSelection && mainSelection.rangeCount > 0) {
                        try {
                            const mainRange = mainSelection.getRangeAt(0);
                            rect = mainRange.getBoundingClientRect();
                            console.log('ä¸»çª—å£é€‰ä¸­åŒºåŸŸçš„ä½ç½®:', rect);
                        } catch (error) {
                            console.error('è·å–ä¸»çª—å£é€‰æ‹©èŒƒå›´å¤±è´¥:', error);
                        }
                    } else if (window.selectionRange) {
                        // å¦‚æœä¸»çª—å£æ²¡æœ‰é€‰æ‹©ï¼Œå°è¯•ä½¿ç”¨å…¨å±€çš„ selectionRange
                        try {
                            rect = window.selectionRange.getBoundingClientRect();
                            console.log('ä½¿ç”¨å…¨å±€ selectionRange è·å–é€‰ä¸­åŒºåŸŸçš„ä½ç½®:', rect);
                        } catch (error) {
                            console.error('ä½¿ç”¨å…¨å±€ selectionRange è·å– rect å¤±è´¥:', error);
                        }
                    }
                }
                
                // å¦‚æœæ‰¾åˆ°äº†é€‰æ‹©èŒƒå›´
                if (rect) {
                    // å¼ºåˆ¶è®¾ç½®èœå•çš„å®½åº¦ï¼Œç¡®ä¿å®ƒæœ‰ä¸€ä¸ªå›ºå®šçš„å°ºå¯¸
                    menu.style.width = '120px';
                    
                    // è®¡ç®—èœå•ä½ç½®ï¼Œç¡®ä¿åœ¨é€‰æ‹©çš„æ–‡å­—æ—è¾¹
                    // èœå•ä½ç½®åœ¨é€‰æ‹©åŒºåŸŸçš„æ­£ä¸‹æ–¹ï¼Œç»å¯¹ä¸ä¼šé®æŒ¡æ–‡å­—
                    let left = rect.left; // èœå•ä½ç½®åœ¨é€‰æ‹©åŒºåŸŸçš„å·¦ä¾§
                    let top = rect.bottom + 8; // èœå•ä½ç½®åœ¨é€‰æ‹©åŒºåŸŸçš„æ­£ä¸‹æ–¹ï¼Œè·ç¦»8pxï¼Œç¡®ä¿ä¸é®æŒ¡
                    
                    // è°ƒæ•´ä½ç½®ï¼Œç¡®ä¿èœå•åœ¨è§†å£å†…
                    if (left < 10) left = 10;
                    if (left + 120 > window.innerWidth) left = window.innerWidth - 130;
                    if (top + menu.offsetHeight > window.innerHeight) {
                        // å¦‚æœä¸‹æ–¹ç©ºé—´ä¸è¶³ï¼Œåˆ™æ˜¾ç¤ºåœ¨ä¸Šæ–¹ï¼Œä½†è¦ç¡®ä¿ä¸é®æŒ¡æ–‡å­—
                        top = rect.top - menu.offsetHeight - 8;
                        if (top < 10) {
                            // å¦‚æœä¸Šæ–¹ä¹Ÿä¸è¶³ï¼Œåˆ™æ˜¾ç¤ºåœ¨å³ä¾§
                            top = rect.top + (rect.height - menu.offsetHeight) / 2;
                            left = rect.left + rect.width + 10;
                            if (left + 120 > window.innerWidth) {
                                left = rect.left - 130;
                                if (left < 10) {
                                    left = 10;
                                }
                            }
                        }
                    }
                    
                    console.log('è®¡ç®—çš„èœå•ä½ç½®:', left, top);
                    
                    // ç›´æ¥è®¾ç½®èœå•ä½ç½®ï¼Œç¡®ä¿æ¯æ¬¡éƒ½æ›´æ–°
                    menu.style.position = 'fixed';
                    menu.style.left = `${left}px`;
                    menu.style.top = `${top}px`;
                    menu.style.display = 'block';
                    console.log('èœå•å·²æ˜¾ç¤º');
                } else {
                    // å¦‚æœä»ç„¶æ²¡æœ‰æ‰¾åˆ°é€‰æ‹©èŒƒå›´ï¼Œä½†æœ‰é€‰ä¸­çš„æ–‡æœ¬ï¼Œä½¿ç”¨ä¸€ä¸ªé»˜è®¤ä½ç½®
                    if (window.selectedText) {
                        console.log('æœªæ‰¾åˆ°é€‰æ‹©èŒƒå›´ï¼Œä½†æœ‰é€‰ä¸­çš„æ–‡æœ¬ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®');
                        menu.style.position = 'fixed';
                        menu.style.left = '100px';
                        menu.style.top = '100px';
                        menu.style.display = 'block';
                        console.log('èœå•å·²æ˜¾ç¤ºï¼ˆä½¿ç”¨é»˜è®¤ä½ç½®ï¼‰');
                    } else {
                        console.error('æœªæ‰¾åˆ°é€‰æ‹©èŒƒå›´å’Œé€‰ä¸­çš„æ–‡æœ¬');
                        hideSelectionMenu();
                    }
                }
            }
        }
        
        // éšè—æ–‡æœ¬é€‰æ‹©èœå•
        function hideSelectionMenu() {
            console.log('éšè—æ–‡æœ¬é€‰æ‹©èœå•');
            const menu = document.getElementById('selection-menu');
            if (menu) {
                menu.style.display = 'none';
                console.log('èœå•å·²éšè—');
            }
        }
        
        // æ‰“å¼€æ‰¹æ³¨å¼¹çª—
        function openNotePopup() {
            const popup = document.getElementById('note-popup');
            if (popup) {
                // æ˜¾ç¤ºå¼¹çª—
                popup.classList.add('show');
                
                // æ¸…ç©ºå¹¶èšç„¦æ‰¹æ³¨å†…å®¹è¾“å…¥æ¡†
                document.getElementById('note-content').value = '';
                document.getElementById('note-content').focus();
                
                // é‡ç½®é¢œè‰²é€‰æ‹©
                selectedColor = '#ffff00';
                document.querySelectorAll('.color-option').forEach(option => {
                    option.style.borderColor = 'transparent';
                });
                document.querySelector('[data-color="#ffff00"]').style.borderColor = '#409eff';
                document.querySelector('[data-color="#ffff00"]').style.transform = 'scale(1.1)';
            }
        }
        
        // å…³é—­æ‰¹æ³¨å¼¹çª—
        function closeNotePopup() {
            const popup = document.getElementById('note-popup');
            if (popup) {
                popup.classList.remove('show');
            }
            // æ¸…é™¤é€‰ä¸­çš„æ–‡æœ¬å’Œé€‰æ‹©èŒƒå›´ï¼Œç¡®ä¿ä¸‹æ¬¡é€‰æ‹©æ—¶èœå•ä½ç½®æ­£ç¡®æ›´æ–°
            window.selectedText = '';
            window.selectionRange = null;
            // æ¸…é™¤æ–‡æ¡£ä¸­çš„é€‰æ‹©
            const selection = window.getSelection();
            if (selection) {
                selection.removeAllRanges();
            }
            // æ¸…é™¤æ‰€æœ‰iframeä¸­çš„é€‰æ‹©
            const iframes = document.querySelectorAll('iframe');
            for (let i = 0; i < iframes.length; i++) {
                try {
                    const iframe = iframes[i];
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    if (iframeDoc) {
                        const iframeSelection = iframeDoc.getSelection();
                        if (iframeSelection) {
                            iframeSelection.removeAllRanges();
                        }
                    }
                } catch (error) {
                    console.error('æ¸…é™¤iframeé€‰æ‹©å¤±è´¥:', error);
                }
            }
        }
        
        // ä¿å­˜æ‰¹æ³¨
        function saveNote() {
            console.log('ä¿å­˜æ‰¹æ³¨å‡½æ•°è¢«è°ƒç”¨');
            const noteContent = document.getElementById('note-content').value.trim();
            console.log('æ‰¹æ³¨å†…å®¹:', noteContent);
            console.log('é€‰ä¸­çš„æ–‡æœ¬:', window.selectedText);
            console.log('å½“å‰ä¹¦ç±:', currentBook);
            console.log('å½“å‰ç« èŠ‚:', currentChapter);
            console.log('é€‰ä¸­é¢œè‰²:', selectedColor);
            console.log('chaptersæ•°ç»„:', chapters);
            console.log('chaptersé•¿åº¦:', chapters.length);
            
            if (window.selectedText && noteContent) {
                const annotation = {
                    id: Date.now().toString(),
                    bookId: currentBook ? currentBook.id || currentBook.title : 'unknown',
                    chapterIndex: currentChapter,
                    chapterTitle: chapters[currentChapter] ? chapters[currentChapter].title : 'unknown',
                    selectedText: window.selectedText,
                    note: noteContent,
                    color: selectedColor,
                    createdAt: new Date().toISOString()
                };
                
                console.log('åˆ›å»ºçš„æ‰¹æ³¨å¯¹è±¡:', annotation);
                
                // ç¡®ä¿annotationsæ•°ç»„å­˜åœ¨
                if (!annotations) {
                    annotations = [];
                    console.log('åˆå§‹åŒ–annotationsæ•°ç»„');
                }
                
                annotations.push(annotation);
                console.log('æ·»åŠ æ‰¹æ³¨åannotationsé•¿åº¦:', annotations.length);
                
                saveAnnotations();
                renderAnnotationsList();
                highlightAnnotations();
                closeNotePopup();
                
                console.log('æ‰¹æ³¨ä¿å­˜æˆåŠŸ');
            } else {
                console.error('ä¿å­˜æ‰¹æ³¨å¤±è´¥ï¼šç¼ºå°‘å¿…è¦ä¿¡æ¯');
                console.error('é€‰ä¸­çš„æ–‡æœ¬:', window.selectedText);
                console.error('æ‰¹æ³¨å†…å®¹:', noteContent);
                alert('è¯·é€‰æ‹©æ–‡å­—å¹¶è¾“å…¥æ‰¹æ³¨å†…å®¹');
            }
        }
        
        // ç»‘å®šè§å…‰ç¬”é¢œè‰²é€‰æ‹©äº‹ä»¶
        function bindColorSelectionEvents() {
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function() {
                    // é‡ç½®æ‰€æœ‰é¢œè‰²é€‰é¡¹
                    document.querySelectorAll('.color-option').forEach(opt => {
                        opt.style.borderColor = 'transparent';
                        opt.style.transform = 'scale(1)';
                    });
                    
                    // è®¾ç½®é€‰ä¸­çš„é¢œè‰²
                    selectedColor = this.dataset.color;
                    this.style.borderColor = '#409eff';
                    this.style.transform = 'scale(1.1)';
                });
            });
        }
        
        // é«˜äº®æ‰¹æ³¨æ–‡æœ¬
        function highlightAnnotations() {
            console.log('é«˜äº®æ‰¹æ³¨æ–‡æœ¬');
            
            // è·å–å½“å‰é€‰ä¸­çš„æ–‡æœ¬èŒƒå›´
            if (window.selectionRange) {
                try {
                    console.log('ä½¿ç”¨å…¨å±€ selectionRange è¿›è¡Œé«˜äº®');
                    
                    // åˆ›å»ºé«˜äº®æ•ˆæœ
                    const range = window.selectionRange;
                    const selectedText = range.toString().trim();
                    
                    if (selectedText) {
                        console.log('é€‰ä¸­æ–‡æœ¬:', selectedText);
                        console.log('é«˜äº®é¢œè‰²:', selectedColor);
                        
                        // åˆ›å»ºspanå…ƒç´ åŒ…è£¹é€‰ä¸­çš„æ–‡æœ¬
                        const span = document.createElement('span');
                        span.style.backgroundColor = selectedColor;
                        span.style.padding = '0 2px';
                        span.style.borderRadius = '2px';
                        span.style.transition = 'all 0.3s ease';
                        span.setAttribute('data-annotation', 'true');
                        
                        // å°è¯•ä½¿ç”¨surroundContentsæ–¹æ³•
                        try {
                            range.surroundContents(span);
                            console.log('ä½¿ç”¨surroundContentsæ–¹æ³•æˆåŠŸæ·»åŠ é«˜äº®');
                        } catch (error) {
                            console.error('surroundContentså¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•:', error);
                            
                            // å¤‡ç”¨æ–¹æ³•ï¼šåˆ›å»ºæ–°çš„æ–‡æœ¬èŠ‚ç‚¹
                            const fragment = range.extractContents();
                            span.appendChild(fragment);
                            range.insertNode(span);
                            console.log('ä½¿ç”¨extractContentså’ŒinsertNodeæ–¹æ³•æ·»åŠ é«˜äº®');
                        }
                    }
                } catch (error) {
                    console.error('é«˜äº®æ–‡æœ¬å¤±è´¥:', error);
                }
            } else {
                console.error('æ²¡æœ‰é€‰ä¸­çš„æ–‡æœ¬èŒƒå›´');
            }
        }
        
        // æ‰“å¼€æ‰¹æ³¨ä¾§è¾¹æ 
        function openNotesSidebar() {
            console.log('æ‰“å¼€æ‰¹æ³¨ä¾§è¾¹æ ');
            // ç›´æ¥æ“ä½œæ ·å¼ï¼Œä¸ä½¿ç”¨ç±»
            const sidebar = document.getElementById('notes-sidebar');
            const overlay = document.getElementById('overlay');
            if (sidebar && overlay) {
                console.log('æ‰¾åˆ°æ‰¹æ³¨ä¾§è¾¹æ å’Œé®ç½©å±‚å…ƒç´ ');
                // æ˜¾ç¤ºä¾§è¾¹æ 
                sidebar.style.transform = 'translateX(0)';
                sidebar.style.display = 'block';
                // æ˜¾ç¤ºé®ç½©å±‚
                overlay.style.display = 'block';
                // æ¸²æŸ“æ‰¹æ³¨åˆ—è¡¨
                renderAnnotationsList();
            } else {
                console.error('æœªæ‰¾åˆ°å¿…è¦çš„å…ƒç´ ');
                console.log('sidebar:', sidebar);
                console.log('overlay:', overlay);
            }
        }
        
        // å…³é—­æ‰¹æ³¨ä¾§è¾¹æ 
        function closeNotesSidebar() {
            console.log('å…³é—­æ‰¹æ³¨ä¾§è¾¹æ ');
            // ç›´æ¥æ“ä½œæ ·å¼ï¼Œä¸ä½¿ç”¨ç±»
            const sidebar = document.getElementById('notes-sidebar');
            const overlay = document.getElementById('overlay');
            if (sidebar && overlay) {
                // éšè—ä¾§è¾¹æ 
                sidebar.style.transform = 'translateX(-100%)';
                // éšè—é®ç½©å±‚
                overlay.style.display = 'none';
            }
        }
        
        // åŠ è½½æ‰¹æ³¨
        function loadAnnotations() {
            console.log('åŠ è½½æ‰¹æ³¨å‡½æ•°è¢«è°ƒç”¨');
            console.log('currentBook:', currentBook);
            
            // å³ä½¿currentBookä¸ºnullï¼Œä¹Ÿå°è¯•åŠ è½½æ‰¹æ³¨ï¼ˆä½¿ç”¨é»˜è®¤bookIdï¼‰
            const bookId = currentBook ? currentBook.id || currentBook.title : 'unknown';
            console.log('ä¹¦ç±ID:', bookId);
            const storedAnnotations = localStorage.getItem(`godReaderAnnotations_${bookId}`);
            console.log('æœ¬åœ°å­˜å‚¨çš„æ‰¹æ³¨æ•°æ®:', storedAnnotations);
            
            if (storedAnnotations) {
                try {
                    annotations = JSON.parse(storedAnnotations);
                    console.log('åŠ è½½çš„æ‰¹æ³¨æ•°é‡:', annotations.length);
                } catch (error) {
                    console.error('åŠ è½½æ‰¹æ³¨å¤±è´¥:', error);
                    annotations = [];
                }
            } else {
                console.log('æœ¬åœ°å­˜å‚¨ä¸­æ²¡æœ‰æ‰¹æ³¨æ•°æ®');
                annotations = [];
            }
        }
        
        // ä¿å­˜æ‰¹æ³¨
        function saveAnnotations() {
            console.log('ä¿å­˜æ‰¹æ³¨åˆ°æœ¬åœ°å­˜å‚¨');
            console.log('currentBook:', currentBook);
            console.log('annotationsæ•°ç»„:', annotations);
            
            // å³ä½¿currentBookä¸ºnullï¼Œä¹Ÿä¿å­˜æ‰¹æ³¨ï¼ˆä½¿ç”¨é»˜è®¤bookIdï¼‰
            const bookId = currentBook ? currentBook.id || currentBook.title : 'unknown';
            console.log('ä¹¦ç±ID:', bookId);
            console.log('å­˜å‚¨çš„æ‰¹æ³¨æ•°é‡:', annotations.length);
            localStorage.setItem(`godReaderAnnotations_${bookId}`, JSON.stringify(annotations));
            console.log('æ‰¹æ³¨ä¿å­˜æˆåŠŸåˆ°æœ¬åœ°å­˜å‚¨');
        }
        
        // æ¸²æŸ“æ‰¹æ³¨åˆ—è¡¨
        function renderAnnotationsList() {
            console.log('æ¸²æŸ“æ‰¹æ³¨åˆ—è¡¨å‡½æ•°è¢«è°ƒç”¨');
            console.log('annotationsæ•°ç»„é•¿åº¦:', annotations.length);
            console.log('annotationsæ•°ç»„å†…å®¹:', annotations);
            
            const notesList = document.getElementById('notes-list');
            console.log('notesListå…ƒç´ :', notesList);
            
            notesList.innerHTML = '';
            
            if (annotations.length === 0) {
                console.log('annotationsæ•°ç»„ä¸ºç©ºï¼Œæ˜¾ç¤ºæš‚æ— æ‰¹æ³¨');
                notesList.innerHTML = '<div style="padding: 24px; text-align: center; color: #999;">æš‚æ— æ‰¹æ³¨</div>';
                return;
            }
            
            console.log('å¼€å§‹æ¸²æŸ“æ‰¹æ³¨åˆ—è¡¨ï¼Œæ‰¹æ³¨æ•°é‡:', annotations.length);
            
            annotations.forEach(annotation => {
                const noteItem = document.createElement('div');
                noteItem.style.padding = '14px 24px';
                noteItem.style.borderBottom = '1px solid #f0f0f0';
                noteItem.style.cursor = 'pointer';
                noteItem.style.transition = 'background-color 0.3s ease';
                noteItem.onmouseover = () => noteItem.style.backgroundColor = '#f8f9ff';
                noteItem.onmouseout = () => noteItem.style.backgroundColor = 'white';
                
                const noteText = document.createElement('div');
                noteText.style.fontSize = '14px';
                noteText.style.color = '#666';
                noteText.style.marginBottom = '8px';
                noteText.style.lineHeight = '1.4';
                noteText.style.wordBreak = 'break-all';
                noteText.style.backgroundColor = annotation.color;
                noteText.style.padding = '4px 8px';
                noteText.style.borderRadius = '4px';
                noteText.textContent = annotation.selectedText;
                
                const noteContent = document.createElement('div');
                noteContent.style.fontSize = '12px';
                noteContent.style.color = '#999';
                noteContent.style.marginBottom = '8px';
                noteContent.style.lineHeight = '1.4';
                noteContent.style.wordBreak = 'break-all';
                noteContent.textContent = annotation.note;
                
                const noteMeta = document.createElement('div');
                noteMeta.style.fontSize = '11px';
                noteMeta.style.color = '#ccc';
                noteMeta.style.marginBottom = '8px';
                noteMeta.textContent = `${annotation.chapterTitle} Â· ${new Date(annotation.createdAt).toLocaleString()}`;
                
                // ç¼–è¾‘æŒ‰é’®
                const editBtn = document.createElement('button');
                editBtn.textContent = 'ç¼–è¾‘';
                editBtn.style.padding = '4px 12px';
                editBtn.style.fontSize = '12px';
                editBtn.style.color = '#409eff';
                editBtn.style.backgroundColor = 'white';
                editBtn.style.border = '1px solid #409eff';
                editBtn.style.borderRadius = '4px';
                editBtn.style.cursor = 'pointer';
                editBtn.style.transition = 'all 0.3s ease';
                editBtn.style.marginRight = '8px';
                editBtn.onmouseover = () => {
                    editBtn.style.backgroundColor = '#409eff';
                    editBtn.style.color = 'white';
                };
                editBtn.onmouseout = () => {
                    editBtn.style.backgroundColor = 'white';
                    editBtn.style.color = '#409eff';
                };
                editBtn.onclick = (e) => {
                    e.stopPropagation();
                    editAnnotation(annotation.id);
                };
                
                // åˆ é™¤æŒ‰é’®
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'åˆ é™¤';
                deleteBtn.style.padding = '4px 12px';
                deleteBtn.style.fontSize = '12px';
                deleteBtn.style.color = '#ff6b6b';
                deleteBtn.style.backgroundColor = 'white';
                deleteBtn.style.border = '1px solid #ff6b6b';
                deleteBtn.style.borderRadius = '4px';
                deleteBtn.style.cursor = 'pointer';
                deleteBtn.style.transition = 'all 0.3s ease';
                deleteBtn.onmouseover = () => {
                    deleteBtn.style.backgroundColor = '#ff6b6b';
                    deleteBtn.style.color = 'white';
                };
                deleteBtn.onmouseout = () => {
                    deleteBtn.style.backgroundColor = 'white';
                    deleteBtn.style.color = '#ff6b6b';
                };
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteAnnotation(annotation.id);
                };
                
                // æŒ‰é’®å®¹å™¨
                const btnContainer = document.createElement('div');
                btnContainer.style.display = 'flex';
                btnContainer.style.justifyContent = 'flex-end';
                btnContainer.style.marginTop = '8px';
                btnContainer.appendChild(editBtn);
                btnContainer.appendChild(deleteBtn);
                
                noteItem.appendChild(noteText);
                noteItem.appendChild(noteContent);
                noteItem.appendChild(noteMeta);
                noteItem.appendChild(btnContainer);
                notesList.appendChild(noteItem);
            });
        }
        
        // åˆ é™¤æ‰¹æ³¨
        function deleteAnnotation(annotationId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ‰¹æ³¨å—ï¼Ÿ')) {
                annotations = annotations.filter(annotation => annotation.id !== annotationId);
                saveAnnotations();
                renderAnnotationsList();
                highlightAnnotations();
            }
        }
        
        // ç¼–è¾‘æ‰¹æ³¨
        function editAnnotation(annotationId) {
            const annotation = annotations.find(annot => annot.id === annotationId);
            if (!annotation) return;
            
            // åˆ›å»ºç¼–è¾‘å¼¹çª—
            const popup = document.createElement('div');
            popup.style.position = 'fixed';
            popup.style.top = '0';
            popup.style.left = '0';
            popup.style.width = '100%';
            popup.style.height = '100%';
            popup.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            popup.style.display = 'flex';
            popup.style.alignItems = 'center';
            popup.style.justifyContent = 'center';
            popup.style.zIndex = '1000';
            
            const content = document.createElement('div');
            content.style.backgroundColor = 'white';
            content.style.padding = '24px';
            content.style.borderRadius = '12px';
            content.style.maxWidth = '500px';
            content.style.width = '90%';
            content.style.boxShadow = '0 4px 24px rgba(0, 0, 0, 0.15)';
            
            const title = document.createElement('h3');
            title.textContent = 'ç¼–è¾‘æ‰¹æ³¨';
            title.style.marginBottom = '16px';
            title.style.fontSize = '18px';
            title.style.color = '#333';
            
            const selectedTextDiv = document.createElement('div');
            selectedTextDiv.style.fontSize = '14px';
            selectedTextDiv.style.color = '#666';
            selectedTextDiv.style.marginBottom = '16px';
            selectedTextDiv.style.backgroundColor = annotation.color;
            selectedTextDiv.style.padding = '8px 12px';
            selectedTextDiv.style.borderRadius = '4px';
            selectedTextDiv.style.opacity = '0.5';
            selectedTextDiv.textContent = 'é€‰ä¸­çš„æ–‡å­—: ' + annotation.selectedText;
            
            const noteLabel = document.createElement('div');
            noteLabel.textContent = 'æ‰¹æ³¨å†…å®¹ï¼š';
            noteLabel.style.fontSize = '14px';
            noteLabel.style.color = '#666';
            noteLabel.style.marginBottom = '8px';
            
            const noteInput = document.createElement('textarea');
            noteInput.value = annotation.note;
            noteInput.style.width = '100%';
            noteInput.style.minHeight = '120px';
            noteInput.style.padding = '12px';
            noteInput.style.border = '1px solid #e0e0e0';
            noteInput.style.borderRadius = '8px';
            noteInput.style.resize = 'vertical';
            noteInput.style.fontFamily = 'inherit';
            noteInput.style.fontSize = '14px';
            noteInput.style.lineHeight = '1.5';
            noteInput.style.marginBottom = '20px';
            
            const btnContainer = document.createElement('div');
            btnContainer.style.display = 'flex';
            btnContainer.style.justifyContent = 'flex-end';
            btnContainer.style.gap = '12px';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'å–æ¶ˆ';
            cancelBtn.style.padding = '8px 24px';
            cancelBtn.style.backgroundColor = '#f0f0f0';
            cancelBtn.style.color = '#333';
            cancelBtn.style.border = 'none';
            cancelBtn.style.borderRadius = '6px';
            cancelBtn.style.cursor = 'pointer';
            cancelBtn.style.fontSize = '14px';
            cancelBtn.style.transition = 'all 0.3s ease';
            cancelBtn.onmouseover = () => cancelBtn.style.backgroundColor = '#e0e0e0';
            cancelBtn.onmouseout = () => cancelBtn.style.backgroundColor = '#f0f0f0';
            cancelBtn.onclick = () => document.body.removeChild(popup);
            
            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'ä¿å­˜';
            saveBtn.style.padding = '8px 24px';
            saveBtn.style.backgroundColor = '#409eff';
            saveBtn.style.color = 'white';
            saveBtn.style.border = 'none';
            saveBtn.style.borderRadius = '6px';
            saveBtn.style.cursor = 'pointer';
            saveBtn.style.fontSize = '14px';
            saveBtn.style.transition = 'all 0.3s ease';
            saveBtn.onmouseover = () => saveBtn.style.backgroundColor = '#66b1ff';
            saveBtn.onmouseout = () => saveBtn.style.backgroundColor = '#409eff';
            saveBtn.onclick = () => {
                const newNote = noteInput.value.trim();
                if (newNote) {
                    annotation.note = newNote;
                    annotation.updatedAt = new Date().toISOString();
                    saveAnnotations();
                    renderAnnotationsList();
                    document.body.removeChild(popup);
                } else {
                    alert('è¯·è¾“å…¥æ‰¹æ³¨å†…å®¹');
                }
            };
            
            btnContainer.appendChild(cancelBtn);
            btnContainer.appendChild(saveBtn);
            
            content.appendChild(title);
            content.appendChild(selectedTextDiv);
            content.appendChild(noteLabel);
            content.appendChild(noteInput);
            content.appendChild(btnContainer);
            
            popup.appendChild(content);
            document.body.appendChild(popup);
            
            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
            popup.addEventListener('click', function(e) {
                if (e.target === popup) {
                    document.body.removeChild(popup);
                }
            });
        }
        
        // é«˜äº®æ˜¾ç¤ºæ‰¹æ³¨
        function highlightAnnotations() {
            console.log('é«˜äº®æ˜¾ç¤ºæ‰¹æ³¨:', annotations.length);
            
            // æ¸…é™¤æ‰€æœ‰ç°æœ‰çš„é«˜äº®
            clearHighlights();
            
            // ä¸ºå½“å‰ç« èŠ‚çš„æ‰¹æ³¨æ·»åŠ é«˜äº®
            const currentChapterAnnotations = annotations.filter(annotation => annotation.chapterIndex === currentChapter);
            console.log('å½“å‰ç« èŠ‚æ‰¹æ³¨æ•°é‡:', currentChapterAnnotations.length);
            
            // æŸ¥æ‰¾å†…å®¹å®¹å™¨
            const contentContainer = document.getElementById('content-container');
            if (!contentContainer) {
                console.error('æœªæ‰¾åˆ°å†…å®¹å®¹å™¨');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦åœ¨iframeä¸­
            const iframes = contentContainer.querySelectorAll('iframe');
            if (iframes.length > 0) {
                // åœ¨iframeä¸­æ·»åŠ é«˜äº®
                const iframe = iframes[0];
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    if (iframeDoc) {
                        addHighlightsToDocument(iframeDoc, currentChapterAnnotations);
                    }
                } catch (error) {
                    console.error('åœ¨iframeä¸­æ·»åŠ é«˜äº®å¤±è´¥:', error);
                }
            } else {
                // åœ¨ä¸»çª—å£ä¸­æ·»åŠ é«˜äº®
                addHighlightsToDocument(document, currentChapterAnnotations);
            }
        }
        
        // åœ¨æ–‡æ¡£ä¸­æ·»åŠ é«˜äº®
        function addHighlightsToDocument(doc, annotations) {
            console.log('åœ¨æ–‡æ¡£ä¸­æ·»åŠ é«˜äº®ï¼Œæ‰¹æ³¨æ•°é‡:', annotations.length);
            
            annotations.forEach(annotation => {
                try {
                    // æŸ¥æ‰¾åŒ…å«æ‰¹æ³¨æ–‡æœ¬çš„èŠ‚ç‚¹
                    const walker = doc.createTreeWalker(
                        doc.body,
                        NodeFilter.SHOW_TEXT,
                        null,
                        false
                    );
                    
                    let node;
                    let found = false;
                    
                    while (node = walker.nextNode()) {
                        if (node.textContent.includes(annotation.selectedText)) {
                            // åˆ›å»ºé«˜äº®æ ‡è®°
                            const highlightSpan = doc.createElement('span');
                            highlightSpan.className = 'annotation-highlight';
                            highlightSpan.style.backgroundColor = annotation.color;
                            highlightSpan.style.padding = '2px 4px';
                            highlightSpan.style.borderRadius = '2px';
                            highlightSpan.style.cursor = 'pointer';
                            highlightSpan.style.opacity = '0.3'; // è®¾ç½®åŠé€æ˜æ•ˆæœï¼Œæ›´é€¼çœŸ
                            highlightSpan.style.transition = 'all 0.3s ease';
                            highlightSpan.style.display = 'inline';
                            highlightSpan.style.position = 'relative';
                            highlightSpan.style.zIndex = '1';
                            highlightSpan.style.boxShadow = 'none';
                            highlightSpan.style.textDecoration = 'none'; // ç§»é™¤ä¸‹åˆ’çº¿
                            highlightSpan.style.color = 'inherit'; // ä¿æŒæ–‡å­—åŸæ¥çš„é¢œè‰²
                            highlightSpan.style.font = 'inherit'; // ä¿æŒæ–‡å­—åŸæ¥çš„å­—ä½“
                            highlightSpan.style.lineHeight = 'inherit'; // ä¿æŒæ–‡å­—åŸæ¥çš„è¡Œé«˜
                            highlightSpan.dataset.annotationId = annotation.id;
                            highlightSpan.title = annotation.note;
                            
                            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œæ˜¾ç¤ºæ‰¹æ³¨å†…å®¹
                            highlightSpan.addEventListener('click', function(e) {
                                e.stopPropagation();
                                showAnnotationPopup(annotation);
                            });
                            
                            // æ›¿æ¢æ–‡æœ¬èŠ‚ç‚¹
                            const textContent = node.textContent;
                            const beforeText = textContent.substring(0, textContent.indexOf(annotation.selectedText));
                            const afterText = textContent.substring(textContent.indexOf(annotation.selectedText) + annotation.selectedText.length);
                            
                            const parentNode = node.parentNode;
                            
                            if (beforeText) {
                                parentNode.insertBefore(doc.createTextNode(beforeText), node);
                            }
                            
                            highlightSpan.textContent = annotation.selectedText;
                            parentNode.insertBefore(highlightSpan, node);
                            
                            if (afterText) {
                                parentNode.insertBefore(doc.createTextNode(afterText), node);
                            }
                            
                            parentNode.removeChild(node);
                            found = true;
                            break;
                        }
                    }
                    
                    if (!found) {
                        console.warn('æœªæ‰¾åˆ°æ‰¹æ³¨æ–‡æœ¬:', annotation.selectedText);
                    }
                } catch (error) {
                    console.error('æ·»åŠ é«˜äº®å¤±è´¥:', error);
                }
            });
        }
        
        // æ˜¾ç¤ºæ‰¹æ³¨å¼¹çª—
        function showAnnotationPopup(annotation) {
            const popup = document.createElement('div');
            popup.style.position = 'fixed';
            popup.style.top = '50%';
            popup.style.left = '50%';
            popup.style.transform = 'translate(-50%, -50%)';
            popup.style.backgroundColor = 'white';
            popup.style.padding = '24px';
            popup.style.borderRadius = '12px';
            popup.style.boxShadow = '0 4px 24px rgba(0, 0, 0, 0.15)';
            popup.style.zIndex = '1000';
            popup.style.maxWidth = '400px';
            popup.style.width = '90%';
            
            const title = document.createElement('h3');
            title.textContent = 'æ‰¹æ³¨è¯¦æƒ…';
            title.style.marginBottom = '16px';
            title.style.fontSize = '18px';
            title.style.color = '#333';
            
            const selectedText = document.createElement('div');
            selectedText.textContent = annotation.selectedText;
            selectedText.style.backgroundColor = annotation.color;
            selectedText.style.padding = '8px 12px';
            selectedText.style.borderRadius = '4px';
            selectedText.style.marginBottom = '12px';
            selectedText.style.fontSize = '14px';
            selectedText.style.lineHeight = '1.4';
            
            const noteLabel = document.createElement('div');
            noteLabel.textContent = 'æ‰¹æ³¨å†…å®¹ï¼š';
            noteLabel.style.fontSize = '14px';
            noteLabel.style.color = '#666';
            noteLabel.style.marginBottom = '8px';
            
            const noteContent = document.createElement('div');
            noteContent.textContent = annotation.note;
            noteContent.style.backgroundColor = '#f8f9ff';
            noteContent.style.padding = '12px';
            noteContent.style.borderRadius = '8px';
            noteContent.style.fontSize = '14px';
            noteContent.style.lineHeight = '1.6';
            noteContent.style.marginBottom = '16px';
            noteContent.style.color = '#333';
            
            const meta = document.createElement('div');
            meta.textContent = `${annotation.chapterTitle} Â· ${new Date(annotation.createdAt).toLocaleString()}`;
            meta.style.fontSize = '12px';
            meta.style.color = '#999';
            meta.style.marginBottom = '16px';
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'å…³é—­';
            closeBtn.style.padding = '8px 24px';
            closeBtn.style.backgroundColor = '#409eff';
            closeBtn.style.color = 'white';
            closeBtn.style.border = 'none';
            closeBtn.style.borderRadius = '6px';
            closeBtn.style.cursor = 'pointer';
            closeBtn.style.fontSize = '14px';
            closeBtn.style.transition = 'all 0.3s ease';
            closeBtn.onmouseover = () => closeBtn.style.backgroundColor = '#66b1ff';
            closeBtn.onmouseout = () => closeBtn.style.backgroundColor = '#409eff';
            closeBtn.onclick = () => document.body.removeChild(popup);
            
            popup.appendChild(title);
            popup.appendChild(selectedText);
            popup.appendChild(noteLabel);
            popup.appendChild(noteContent);
            popup.appendChild(meta);
            popup.appendChild(closeBtn);
            
            document.body.appendChild(popup);
            
            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
            popup.addEventListener('click', function(e) {
                if (e.target === popup) {
                    document.body.removeChild(popup);
                }
            });
        }
        
        // æ¸…é™¤æ‰€æœ‰é«˜äº®
        function clearHighlights() {
            console.log('æ¸…é™¤æ‰€æœ‰é«˜äº®');
            
            // æŸ¥æ‰¾å†…å®¹å®¹å™¨
            const contentContainer = document.getElementById('content-container');
            if (!contentContainer) {
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦åœ¨iframeä¸­
            const iframes = contentContainer.querySelectorAll('iframe');
            if (iframes.length > 0) {
                // åœ¨iframeä¸­æ¸…é™¤é«˜äº®
                const iframe = iframes[0];
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    if (iframeDoc) {
                        const highlights = iframeDoc.querySelectorAll('.annotation-highlight');
                        highlights.forEach(highlight => {
                            const parent = highlight.parentNode;
                            const text = highlight.textContent;
                            parent.replaceChild(iframeDoc.createTextNode(text), highlight);
                            parent.normalize();
                        });
                    }
                } catch (error) {
                    console.error('åœ¨iframeä¸­æ¸…é™¤é«˜äº®å¤±è´¥:', error);
                }
            } else {
                // åœ¨ä¸»çª—å£ä¸­æ¸…é™¤é«˜äº®
                const highlights = document.querySelectorAll('.annotation-highlight');
                highlights.forEach(highlight => {
                    const parent = highlight.parentNode;
                    const text = highlight.textContent;
                    parent.replaceChild(document.createTextNode(text), highlight);
                    parent.normalize();
                });
            }
        }
        
        // åˆå§‹åŒ–åº”ç”¨
        init();
    </script>
</body>
</html>